<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financiero Integrado</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body>
    <!-- Sección de Login -->
    <div id="login-section">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-chart-pie fa-3x"></i>
            </div>
            <div class="login-header">
                <h2>Dashboard Financiero Integrado</h2>
                <p>Acceso a Reportes Financieros</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Ingresar al Sistema
                </button>
                <div id="login-error" class="login-error"></div>
            </form>
        </div>
    </div>

    <!-- Navegación Principal (visible después del login) -->
    <div id="main-navigation" class="hidden">
        <div class="navigation-container">
            <div class="navigation-header">
                <h1><i class="fas fa-chart-pie"></i> Dashboard Financiero</h1>
                <div class="user-info">
                    <span id="user-display">Usuario</span>
                    <button id="logout-button" class="btn btn-outline">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
            <div class="dashboard-cards">
                <div class="dashboard-card" data-dashboard="ventas">
                    <div class="card-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="card-content">
                        <h3>Ventas</h3>
                        <p>Reportes y análisis de ventas</p>
                    </div>
                </div>
                <div class="dashboard-card" data-dashboard="compras">
                    <div class="card-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="card-content">
                        <h3>Compras</h3>
                        <p>Reportes y análisis de compras</p>
                    </div>
                </div>
                <div class="dashboard-card" data-dashboard="comparativo">
                    <div class="card-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="card-content">
                        <h3>Comparativo</h3>
                        <p>Análisis comparativo de ventas y compras</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor para todos los dashboards -->
    <div id="dashboards-container" class="hidden">
        <!-- Barra superior común para todos los dashboards -->
        <div class="dashboard-topbar">
            <button class="back-to-menu-btn">
                <i class="fas fa-arrow-left"></i> Volver al Menú
            </button>
            <div class="dashboard-title">
                <span id="current-dashboard-title">Dashboard</span>
            </div>
            <div class="user-controls">
                <span id="topbar-user-display">Usuario</span>
                <button id="topbar-logout-button" class="btn btn-sm btn-outline">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>

        <!-- Dashboard de Ventas -->
        <div id="ventas-dashboard" class="dashboard-content hidden">
            <!-- El contenido del dashboard de ventas se insertará aquí -->
        </div>

        <!-- Dashboard de Compras -->
        <div id="compras-dashboard" class="dashboard-content hidden">
            <!-- El contenido del dashboard de compras se insertará aquí -->
        </div>

        <!-- Dashboard Comparativo -->
        <div id="comparativo-dashboard" class="dashboard-content hidden">
            <!-- El contenido del dashboard comparativo se insertará aquí -->
        </div>
    </div>

    <!-- Toast para notificaciones -->
    <div id="toast" class="toast"></div>
</body>
</html>




:root {
    --primary: #1a237e;           /* Azul oscuro - color principal */
    --primary-light: #3949ab;     /* Azul medio - color principal más claro */
    --primary-dark: #0d1442;      /* Azul muy oscuro - para hover */
    --secondary: #283593;         /* Azul secundario */
    --accent: #FFC107;            /* Ámbar - color de acento */
    --success: #4CAF50;           /* Verde - éxito */
    --warning: #FF9800;           /* Naranja - advertencia */
    --danger: #F44336;            /* Rojo - error/peligro */
    --light: #f8f9fa;             /* Gris muy claro - fondo */
    --dark: #343a40;              /* Gris oscuro - texto principal */
    --gray-light: #e9ecef;        /* Gris claro - bordes, separadores */
    --gray: #adb5bd;              /* Gris medio - texto secundario */
    --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);  /* Sombra estándar */
    --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.15);  /* Sombra para hover */
    --transition: all 0.3s ease;  /* Transición estándar */
    
    /* Colores para los gráficos */
    --chart-color1: #3949ab;
    --chart-color2: #5e35b1;
    --chart-color3: #039be5;
    --chart-color4: #43a047;
    --chart-color5: #fb8c00;
    --chart-color6: #e53935;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: var(--light);
    color: var(--dark);
    line-height: 1.6;
    min-height: 100vh;
}

/* ===== ESTILOS DEL LOGIN ===== */
#login-section {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    padding: 20px;
}

.login-container {
    max-width: 450px;
    width: 100%;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    padding: 40px 30px;
    animation: fadeInUp 0.8s ease forwards;
}

.login-logo {
    text-align: center;
    margin-bottom: 25px;
    color: var(--primary);
}

.login-header {
    text-align: center;
    margin-bottom: 30px;
}

.login-header h2 {
    font-size: 28px;
    color: var(--primary);
    margin-bottom: 12px;
}

.login-header p {
    color: var(--gray);
    font-size: 16px;
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 500;
    color: var(--dark);
}

.form-control {
    width: 100%;
    padding: 14px 18px;
    font-size: 16px;
    border: 1px solid var(--gray-light);
    border-radius: 8px;
    transition: var(--transition);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.2);
}

.btn {
    display: inline-block;
    font-weight: 500;
    text-align: center;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: var(--transition);
}

.btn-primary {
    background-color: var(--primary);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.btn-outline {
    background-color: transparent;
    border: 1px solid var(--primary);
    color: var(--primary);
}

.btn-outline:hover {
    background-color: var(--primary);
    color: white;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 14px;
}

.btn-block {
    display: block;
    width: 100%;
}

.login-error {
    color: var(--danger);
    margin-top: 15px;
    font-size: 14px;
    text-align: center;
    font-weight: 500;
    min-height: 20px;
}

/* ===== NAVEGACIÓN PRINCIPAL ===== */
.navigation-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
}

.navigation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
}

.navigation-header h1 {
    color: var(--primary);
    font-size: 32px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.navigation-header h1 i {
    color: var(--accent);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-info span {
    font-weight: 500;
    font-size: 16px;
}

.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-top: 40px;
}

.dashboard-card {
    background-color: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: var(--transition);
    border-left: 5px solid transparent;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.dashboard-card[data-dashboard="ventas"] {
    border-left-color: var(--success);
}

.dashboard-card[data-dashboard="ventas"]:hover {
    background-color: rgba(76, 175, 80, 0.05);
}

.dashboard-card[data-dashboard="compras"] {
    border-left-color: var(--warning);
}

.dashboard-card[data-dashboard="compras"]:hover {
    background-color: rgba(255, 152, 0, 0.05);
}

.dashboard-card[data-dashboard="comparativo"] {
    border-left-color: var(--accent);
}

.dashboard-card[data-dashboard="comparativo"]:hover {
    background-color: rgba(255, 193, 7, 0.05);
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: var(--light);
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: 20px;
    font-size: 24px;
}

.dashboard-card[data-dashboard="ventas"] .card-icon {
    color: var(--success);
}

.dashboard-card[data-dashboard="compras"] .card-icon {
    color: var(--warning);
}

.dashboard-card[data-dashboard="comparativo"] .card-icon {
    color: var(--accent);
}

.card-content h3 {
    font-size: 20px;
    margin-bottom: 5px;
    color: var(--dark);
}

.card-content p {
    color: var(--gray);
    font-size: 14px;
}

/* ===== DASHBOARD CONTAINERS ===== */
.dashboard-topbar {
    background-color: white;
    padding: 15px 30px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.back-to-menu-btn {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition);
}

.back-to-menu-btn:hover {
    color: var(--primary-dark);
    transform: translateX(-5px);
}

.dashboard-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--primary);
}

.user-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

/* ===== UTILIDADES ===== */
.hidden {
    display: none !important;
}

.toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: var(--primary);
    color: white;
    padding: 12px 25px;
    border-radius: 8px;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.5s ease;
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast.success {
    background-color: var(--success);
}

.toast.warning {
    background-color: var(--warning);
}

.toast.error {
    background-color: var(--danger);
}

/* ===== ANIMACIONES ===== */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 992px) {
    .dashboard-cards {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .navigation-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }
    
    .dashboard-topbar {
        padding: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .user-controls {
        width: 100%;
        justify-content: space-between;
        order: 3;
        margin-top: 10px;
    }
    
    .back-to-menu-btn, .dashboard-title {
        flex: 1;
    }
    
    .dashboard-title {
        text-align: center;
    }
}

@media (max-width: 576px) {
    .login-container {
        padding: 30px 20px;
    }
    
    .dashboard-cards {
        grid-template-columns: 1fr;
    }
    
    .dashboard-card {
        padding: 20px;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
}



<script>
// Credenciales de acceso
const validCredentials = {
    username: "Mireya",
    password: "123#"
};

// Referencias a elementos DOM principales
const loginSection = document.getElementById('login-section');
const loginForm = document.getElementById('login-form');
const loginError = document.getElementById('login-error');
const mainNavigation = document.getElementById('main-navigation');
const dashboardsContainer = document.getElementById('dashboards-container');
const userDisplay = document.getElementById('user-display');
const topbarUserDisplay = document.getElementById('topbar-user-display');

// Referencias a todos los dashboards
const ventasDashboard = document.getElementById('ventas-dashboard');
const comprasDashboard = document.getElementById('compras-dashboard');
const comparativoDashboard = document.getElementById('comparativo-dashboard');
const currentDashboardTitle = document.getElementById('current-dashboard-title');

// Toast para notificaciones
const toast = document.getElementById('toast');

// Manejo de login
loginForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (username === validCredentials.username && password === validCredentials.password) {
        // Login exitoso
        loginSection.classList.add('hidden');
        mainNavigation.classList.remove('hidden');
        
        // Mostrar el nombre de usuario
        userDisplay.textContent = username;
        topbarUserDisplay.textContent = username;
        
        // Mostrar mensaje de bienvenida
        showToast(`Bienvenido(a) ${username}`, 'success');
        
        // Limpiar campos de login
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    } else {
        // Error de login
        loginError.textContent = 'Usuario o contraseña incorrectos';
        // Efecto de animación para el error
        loginError.style.animation = 'none';
        setTimeout(() => {
            loginError.style.animation = 'fadeInUp 0.3s ease';
        }, 10);
    }
});

// Botones de logout (hay dos: en el menú principal y en la barra superior)
document.getElementById('logout-button').addEventListener('click', logout);
document.getElementById('topbar-logout-button').addEventListener('click', logout);

// Función de logout
function logout() {
    mainNavigation.classList.add('hidden');
    dashboardsContainer.classList.add('hidden');
    loginSection.classList.remove('hidden');
    
    // Ocultar todos los dashboards
    ventasDashboard.classList.add('hidden');
    comprasDashboard.classList.add('hidden');
    comparativoDashboard.classList.add('hidden');
    
    showToast('Sesión cerrada correctamente', 'success');
}

// Manejar el clic en las tarjetas de dashboard
document.querySelectorAll('.dashboard-card').forEach(card => {
    card.addEventListener('click', function() {
        const dashboardType = this.getAttribute('data-dashboard');
        showDashboard(dashboardType);
    });
});

// Botón para volver al menú principal
document.querySelectorAll('.back-to-menu-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        dashboardsContainer.classList.add('hidden');
        mainNavigation.classList.remove('hidden');
    });
});

// Función para mostrar un dashboard específico
function showDashboard(type) {
    // Ocultar menú principal y mostrar contenedor de dashboards
    mainNavigation.classList.add('hidden');
    dashboardsContainer.classList.remove('hidden');
    
    // Ocultar todos los dashboards
    ventasDashboard.classList.add('hidden');
    comprasDashboard.classList.add('hidden');
    comparativoDashboard.classList.add('hidden');
    
    // Mostrar el dashboard seleccionado
    if (type === 'ventas') {
        ventasDashboard.classList.remove('hidden');
        currentDashboardTitle.textContent = 'Dashboard de Ventas';
        
        // Si existe la función para inicializar el dashboard de ventas, la llamamos
        if (typeof initializeVentasDashboard === 'function') {
            initializeVentasDashboard();
        }
    } else if (type === 'compras') {
        comprasDashboard.classList.remove('hidden');
        currentDashboardTitle.textContent = 'Dashboard de Compras';
        
        // Si existe la función para inicializar el dashboard de compras, la llamamos
        if (typeof initializeComprasDashboard === 'function') {
            initializeComprasDashboard();
        }
    } else if (type === 'comparativo') {
        comparativoDashboard.classList.remove('hidden');
        currentDashboardTitle.textContent = 'Dashboard Comparativo';
        
        // Si existe la función para inicializar el dashboard comparativo, la llamamos
        if (typeof initializeComparativoDashboard === 'function') {
            initializeComparativoDashboard();
        }
    }
}

// Función para mostrar notificaciones toast
function showToast(message, type = 'default') {
    toast.textContent = message;
    toast.className = 'toast';
    
    // Agregar la clase según el tipo
    if (type) {
        toast.classList.add(type);
    }
    
    // Mostrar el toast
    toast.classList.add('show');
    
    // Ocultar después de 3 segundos
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}
</script>

<script>
// Función de inicialización para el Dashboard de Ventas
function initializeVentasDashboard() {
    // Insertar el contenido HTML en el contenedor
    document.getElementById('ventas-dashboard').innerHTML = `
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title"><i class="fas fa-chart-line"></i> Dashboard de Facturación</h1>
                <div class="dashboard-controls">
                    <button id="load-button-ventas" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> Actualizar Datos
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filter-container">
                <div class="filter-item">
                    <span class="filter-label">Año</span>
                    <select id="year-filter-ventas" class="filter-select" multiple="multiple">
                        <!-- Opciones generadas dinámicamente -->
                    </select>
                </div>
                <div class="filter-item">
                    <span class="filter-label">Mes</span>
                    <select id="month-filter-ventas" class="filter-select" multiple="multiple">
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="filter-item">
                    <span class="filter-label">Cliente</span>
                    <select id="client-filter-ventas" class="filter-select" multiple="multiple">
                        <!-- Opciones generadas dinámicamente -->
                    </select>
                </div>
                <div class="filter-item">
                    <span class="filter-label">Acciones</span>
                    <button id="reset-filters-ventas" class="btn btn-outline btn-block">
                        <i class="fas fa-filter"></i> Limpiar Filtros
                    </button>
                </div>
            </div>

            <!-- Mensaje de error y carga -->
            <div id="loading-message-ventas" class="loader-container hidden">
                <div class="loader"></div>
            </div>
            <div id="error-message-ventas" class="error-message"></div>

            <!-- Tarjetas de Estadísticas -->
            <div id="stats-container-ventas" class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">Total Facturado (con IVA)</div>
                    <div id="total-facturado" class="stat-value">$0</div>
                    <div id="total-facturado-subtitle" class="stat-subtitle">0 documentos</div>
                    <div id="trend-facturado" class="stat-trend trend-up">
                        <i class="fas fa-arrow-up trend-icon"></i> 0% vs. año anterior
                    </div>
                    <i class="fas fa-file-invoice-dollar stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Notas de Crédito</div>
                    <div id="total-nc" class="stat-value">$0</div>
                    <div id="total-nc-subtitle" class="stat-subtitle">0 documentos</div>
                    <div id="trend-nc" class="stat-trend trend-down">
                        <i class="fas fa-arrow-down trend-icon"></i> 0% vs. año anterior
                    </div>
                    <i class="fas fa-file-medical stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Ventas Brutas (Neto+Exento+IVA-NC)</div>
                    <div id="ventas-brutas" class="stat-value">$0</div>
                    <div id="ventas-brutas-subtitle" class="stat-subtitle">0% del total facturado</div>
                    <div id="trend-bruto" class="stat-trend trend-up">
                        <i class="fas fa-arrow-up trend-icon"></i> 0% vs. año anterior
                    </div>
                    <i class="fas fa-hand-holding-usd stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Ventas Netas (Neto+Exento-NC)</div>
                    <div id="ventas-netas" class="stat-value">$0</div>
                    <div id="ventas-netas-subtitle" class="stat-subtitle">En 0 meses con facturación</div>
                    <div id="trend-neto" class="stat-trend trend-neutral">
                        <i class="fas fa-equals trend-icon"></i> Comparativa mensual
                    </div>
                    <i class="fas fa-chart-line stat-icon"></i>
                </div>
            </div>

            <!-- Comparativo Anual -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> Análisis Comparativo</h2>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Comparativo de Ventas Anuales</h3>
                            <p class="chart-subtitle">Visualización de ventas netas por año</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="yearlyComparisonChart-ventas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Matriz de datos (mapa de calor) -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-th"></i> Matriz de Ventas Mensuales</h2>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Mapa de Calor de Ventas</h3>
                            <p class="chart-subtitle">Distribución de ventas por mes y año</p>
                        </div>
                    </div>
                    <div class="heatmap-container">
                        <table id="heatmap-table-ventas" class="heatmap-table">
                            <!-- Contenido generado dinámicamente -->
                        </table>
                    </div>
                </div>
            </div>

            <!-- Evolución de Ventas -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-line"></i> Evolución Mensual</h2>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Evolución de Ventas por Mes</h3>
                            <p class="chart-subtitle">Tendencias de ventas mensuales agrupadas por año</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesChart-ventas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Comparativo Mensual -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> Comparativo Mensual</h2>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Ventas por Mes</h3>
                            <p class="chart-subtitle">Comparación de ventas entre meses</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyComparisonChart-ventas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Análisis Avanzado -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-brain"></i> Análisis Avanzado</h2>
                </div>
                <div class="chart-grid">
                    <div class="chart-grid-item">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Distribución de Ventas</h3>
                            </div>
                            <div class="chart-container" style="height: 300px">
                                <canvas id="distributionChart-ventas"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-grid-item">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Promedios Mensuales por Año</h3>
                            </div>
                            <div class="chart-container" style="height: 300px">
                                <canvas id="monthlyAverageChart-ventas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Métricas Clave de Rendimiento</h3>
                    </div>
                    <div class="analysis-grid" id="key-metrics-container-ventas">
                        <!-- Métricas generadas dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Top Clientes -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-users"></i> Top 3 Clientes</h2>
                </div>
                <div id="clients-container-ventas" class="clients-container"></div>
            </div>

            <!-- Tabla de Facturas -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-table"></i> Detalle de Documentos</h2>
                </div>
                
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">Registro de Facturas y Notas de Crédito</h3>
                        <div class="table-actions">
                            <select id="table-page-size-ventas" class="filter-select">
                                <option value="10">10 por página</option>
                                <option value="25">25 por página</option>
                                <option value="50">50 por página</option>
                                <option value="100">100 por página</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th data-sort="folio">Folio <i class="fas fa-sort"></i></th>
                                    <th data-sort="fecha">Fecha <i class="fas fa-sort"></i></th>
                                    <th data-sort="razonSocial">Cliente <i class="fas fa-sort"></i></th>
                                    <th data-sort="montoNetoSinIVA">Monto Neto <i class="fas fa-sort"></i></th>
                                    <th data-sort="exento">Exento <i class="fas fa-sort"></i></th>
                                    <th data-sort="totalConIVA">Total c/IVA <i class="fas fa-sort"></i></th>
                                    <th data-sort="montoNC">Notas Crédito <i class="fas fa-sort"></i></th>
                                    <th data-sort="montoNeto">Saldo <i class="fas fa-sort"></i></th>
                                </tr>
                            </thead>
                            <tbody id="invoice-table-body-ventas">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-ventas" class="pagination">
                        <!-- Paginación se generará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    `;

    // Variables para gráficos de ventas
    let salesChart;
    let distributionChart;
    let yearlyComparisonChart;
    let monthlyAverageChart;
    let monthlyComparisonChart;

    // Variables para datos
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let rowsPerPage = 10;
    let yearOptions = new Set();
    let clientOptions = new Set();

    // Variables para ordenamiento
    let currentSortColumn = 'fecha';
    let currentSortDirection = 'desc';

    // URL del flujo
    const flowUrl = 'https://prod-77.westus.logic.azure.com:443/workflows/1ba29feb037d422bb281c8c8eacc4a04/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9gjMKfE5XIxBTi-KNXchpZN6eGq8xDgrM5g';

    // Referencias a elementos DOM específicos de ventas
    const loadButton = document.getElementById('load-button-ventas');
    const loadingMessage = document.getElementById('loading-message-ventas');
    const errorMessage = document.getElementById('error-message-ventas');
    const resetFiltersButton = document.getElementById('reset-filters-ventas');
    const yearFilter = document.getElementById('year-filter-ventas');
    const monthFilter = document.getElementById('month-filter-ventas');
    const clientFilter = document.getElementById('client-filter-ventas');
    const invoiceTableBody = document.getElementById('invoice-table-body-ventas');
    const pagination = document.getElementById('pagination-ventas');
    const tablePageSize = document.getElementById('table-page-size-ventas');

    // Inicializar Select2 para filtros múltiples
    function initializeSelect2() {
        // Multiselect para años
        $(yearFilter).select2({
            placeholder: 'Seleccionar años',
            allowClear: true,
            closeOnSelect: false
        });
        
        // Multiselect para meses
        $(monthFilter).select2({
            placeholder: 'Seleccionar meses',
            allowClear: true,
            closeOnSelect: false
        });
        
        // Multiselect para clientes
        $(clientFilter).select2({
            placeholder: 'Seleccionar clientes',
            allowClear: true,
            closeOnSelect: false
        });
    }

    // Inicializar Select2
    initializeSelect2();

    // Formateo de moneda
    function formatCurrency(value) {
        return new Intl.NumberFormat('es-CL', { 
            style: 'currency', 
            currency: 'CLP',
            maximumFractionDigits: 0
        }).format(value);
    }

    // Formateo de porcentaje
    function formatPercent(value) {
        return `${value.toFixed(1)}%`;
    }

    // Función para truncar texto largo
    function truncateText(text, maxLength = 20) {
        if (!text) return 'N/A';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Evento para botón de carga
    loadButton.addEventListener('click', fetchData);

    // Eventos para filtros
    $(yearFilter).on('change', applyFilters);
    $(monthFilter).on('change', applyFilters);
    $(clientFilter).on('change', applyFilters);
    resetFiltersButton.addEventListener('click', resetFilters);
    tablePageSize.addEventListener('change', function() {
        rowsPerPage = parseInt(this.value);
        currentPage = 1;
        updateTable();
    });

    // Configurar eventos de ordenamiento en encabezados de tabla
    document.querySelectorAll('.data-table th').forEach(th => {
        th.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            if (column) {
                if (currentSortColumn === column) {
                    // Cambiar dirección si es la misma columna
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // Nueva columna, establecer dirección por defecto
                    currentSortColumn = column;
                    currentSortDirection = 'asc';
                }
                updateSortIcons();
                sortData();
                updateTable();
            }
        });
    });

    // Actualizar iconos de ordenamiento
    function updateSortIcons() {
        document.querySelectorAll('.data-table th i').forEach(icon => {
            icon.className = 'fas fa-sort';
        });
        
        const currentHeader = document.querySelector(`.data-table th[data-sort="${currentSortColumn}"]`);
        if (currentHeader) {
            const icon = currentHeader.querySelector('i');
            if (icon) {
                icon.className = `fas fa-sort-${currentSortDirection === 'asc' ? 'up' : 'down'}`;
            }
        }
    }

    // Ordenar datos
    function sortData() {
        filteredData.sort((a, b) => {
            let valueA = a[currentSortColumn];
            let valueB = b[currentSortColumn];
            
            // Manejar diferentes tipos de datos
            if (currentSortColumn === 'fecha') {
                valueA = new Date(valueA).getTime();
                valueB = new Date(valueB).getTime();
            } else if (typeof valueA === 'string') {
                valueA = valueA.toLowerCase();
                valueB = valueB.toLowerCase();
            }
            
            // Comparación basada en la dirección
            if (currentSortDirection === 'asc') {
                return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
            } else {
                return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
            }
        });
    }

    // Función para reiniciar filtros
    function resetFilters() {
        // Restablecer Select2
        $(yearFilter).val(null).trigger('change');
        $(monthFilter).val(null).trigger('change');
        $(clientFilter).val(null).trigger('change');
        
        applyFilters();
        showToast('Filtros reiniciados correctamente', 'success');
    }

    // Función para obtener datos
    async function fetchData() {
        // Limpiar y mostrar carga
        resetUI();
        
        try {
            loadingMessage.classList.remove('hidden');
            loadButton.disabled = true;
            
            const response = await fetch(flowUrl);
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!Array.isArray(data)) {
                throw new Error('La respuesta recibida no es un array');
            }
            
            // Procesar datos
            processData(data);
            showToast('Datos de ventas cargados exitosamente', 'success');
            
        } catch (error) {
            console.error('Error al cargar datos:', error);
            errorMessage.textContent = `Error: ${error.message}`;
            showToast('Error al cargar datos de ventas', 'error');
        } finally {
            loadingMessage.classList.add('hidden');
            loadButton.disabled = false;
        }
    }

    // Función para resetear la UI
    function resetUI() {
        errorMessage.textContent = '';
        // Eliminar gráficos existentes
        if (salesChart) salesChart.destroy();
        if (distributionChart) distributionChart.destroy();
        if (yearlyComparisonChart) yearlyComparisonChart.destroy();
        if (monthlyAverageChart) monthlyAverageChart.destroy();
        if (monthlyComparisonChart) monthlyComparisonChart.destroy();
        
        // Limpiar contenedores
        document.getElementById('clients-container-ventas').innerHTML = '';
        document.getElementById('key-metrics-container-ventas').innerHTML = '';
        document.getElementById('heatmap-table-ventas').innerHTML = '';
        invoiceTableBody.innerHTML = '';
        pagination.innerHTML = '';
    }

    // Extraer RUT desde Razón Social
    function extractRUT(razonSocial) {
        if (!razonSocial) return null;
        
        // Buscar patrón de RUT (formato: números-dígito verificador)
        const rutPattern = /\b(\d{1,2}(?:\.\d{3}){2}-[\dkK]|\d{7,8}-[\dkK])\b/i;
        const match = razonSocial.match(rutPattern);
        
        return match ? match[0] : null;
    }

    // Función para procesar datos recibidos
    function processData(data) {
        // Guardar todos los datos
        allData = data.map(item => {
            // Procesar fecha
            let fechaObj;
            try {
                fechaObj = new Date(item['Fecha_x0020_Docto'] || '');
                if (isNaN(fechaObj.getTime())) { // Verificar si la fecha es válida
                    fechaObj = new Date(); // Usar fecha actual como fallback
                }
            } catch (e) {
                fechaObj = new Date();
            }
            
            // Extraer RUT de la razón social
            const razonSocialCompleta = item['Razon_x0020_Social'] || '';
            const rut = extractRUT(razonSocialCompleta);
            
            // Limpiar la razón social (quitar el RUT si existe)
            let razonSocial = razonSocialCompleta;
            if (rut) {
                razonSocial = razonSocialCompleta.replace(rut, '').trim();
                // Eliminar "RUT:" si existe
                razonSocial = razonSocial.replace(/RUT:/i, '').trim();
            }
            
            // Calcular montos relevantes
            const tipoDoc = parseInt(item['Tipo_x0020_Doc'] || 0);
            const esNotaCredito = tipoDoc === 61;
            
            const montoFactura = parseFloat(item.MontoFacturaOriginal || item['Monto_x0020_total'] || 0);
            const montoNC = parseFloat(item.MontoNotasCredito || 0);
            
            // Calcular valores para IVA y exento
            const exento = parseFloat(item.MontoExento || 0);
            const montoNetoSinIVA = parseFloat(item.MontoNetoSinIVA || (montoFactura / 1.19 - exento)) || 0;
            const iva = parseFloat(item.MontoIVA || (montoNetoSinIVA * 0.19)) || 0;
            
            // Total con IVA (para mostrar)
            const totalConIVA = montoNetoSinIVA + exento + iva;
            
            // Monto neto real (descontando NC)
            const montoNeto = parseFloat(item.MontoNetoReal || (montoFactura - montoNC)) || 0;
            
            return {
                folio: item.Folio || 'N/A',
                fecha: fechaObj,
                razonSocial: razonSocial || 'N/A',
                rut: rut || 'N/A',
                montoFactura: montoFactura,
                montoNC: montoNC,
                montoNeto: montoNeto,
                montoNetoSinIVA: montoNetoSinIVA,
                exento: exento,
                iva: iva,
                totalConIVA: totalConIVA,
                anio: fechaObj.getFullYear(),
                mes: String(fechaObj.getMonth() + 1).padStart(2, '0'),
                dia: fechaObj.getDate(),
                diaSemana: fechaObj.getDay(),
                periodo: `${fechaObj.getFullYear()}-${String(fechaObj.getMonth() + 1).padStart(2, '0')}`,
                esNotaCredito: esNotaCredito,
                tipoDoc: tipoDoc
            };
        });
        
        // Extraer opciones de año y cliente para los filtros
        yearOptions = new Set(allData.map(item => item.anio));
        clientOptions = new Set(allData.filter(item => item.razonSocial !== 'N/A').map(item => item.razonSocial));
        
        // Actualizar selectores de filtros
        updateFilterOptions();
        
        // Aplicar filtros (inicialmente muestra todo)
        applyFilters();
    }

    // Actualizar opciones de filtros
    function updateFilterOptions() {
        // Limpiar opciones actuales
        $(yearFilter).empty();
        $(clientFilter).empty();
        
        // Agregar años ordenados de más reciente a más antiguo
        [...yearOptions].sort((a, b) => b - a).forEach(year => {
            const option = new Option(year, year, false, false);
            $(yearFilter).append(option);
        });
        
        // Agregar clientes ordenados alfabéticamente
        [...clientOptions].sort().forEach(client => {
            if (client) {  // Asegurarse de que no sea vacío
                const option = new Option(truncateText(client, 40), client, false, false);
                // Agregar título para ver nombre completo
                option.title = client;
                $(clientFilter).append(option);
            }
        });
        
        // Refrescar Select2
        $(yearFilter).trigger('change');
        $(monthFilter).trigger('change');
        $(clientFilter).trigger('change');
    }

    // Aplicar filtros y actualizar visualización
    function applyFilters() {
        const selectedYears = $(yearFilter).val() || [];
        const selectedMonths = $(monthFilter).val() || [];
        const selectedClients = $(clientFilter).val() || [];
        
        // Filtrar datos según selecciones
        filteredData = allData.filter(item => {
            return (
                // Si no hay años seleccionados, mostrar todos
                (selectedYears.length === 0 || selectedYears.includes(item.anio.toString())) &&
                // Si no hay meses seleccionados, mostrar todos
                (selectedMonths.length === 0 || selectedMonths.includes(item.mes)) &&
                // Si no hay clientes seleccionados, mostrar todos
                (selectedClients.length === 0 || selectedClients.includes(item.razonSocial))
            );
        });
        
        // Aplicar ordenamiento actual
        sortData();
        
        // Resetear a primera página
        currentPage = 1;
        
        // Actualizar visualizaciones
        updateStats();
        updateCharts();
        updateYearlyComparison();
        updateMonthlyComparison();
        updateMonthlyAverages();
        updateHeatmap();
        updateTopClients();
        updateTable();
        updateKeyMetrics();
    }

    // Actualizar estadísticas principales
    function updateStats() {
        // Separar facturas y notas de crédito
        const facturas = filteredData.filter(item => !item.esNotaCredito);
        const notasCredito = filteredData.filter(item => item.esNotaCredito);
        
        // Calcular totales
        const totalFacturado = facturas.reduce((sum, item) => sum + item.totalConIVA, 0);
        const totalNC = notasCredito.reduce((sum, item) => sum + item.totalConIVA, 0);
        
        // Calcular ventas brutas (Neto+Exento+IVA-NC con IVA)
        const ventasBrutas = totalFacturado - totalNC;
        
        // Calcular ventas netas (Neto+Exento-NC sin IVA)
        const totalNeto = facturas.reduce((sum, item) => sum + item.montoNetoSinIVA + item.exento, 0);
        const totalNetoNC = notasCredito.reduce((sum, item) => sum + item.montoNetoSinIVA + item.exento, 0);
        const ventasNetas = totalNeto - totalNetoNC;
        
        const totalFacturasCount = facturas.length;
        const totalNCCount = notasCredito.length;
        
        // Calcular porcentaje de ventas netas sobre total facturado
        const porcentajeNeto = totalFacturado > 0 ? (ventasNetas / ventasBrutas * 100) : 0;
        
        // Calcular promedio mensual
        const periodos = new Set(filteredData.map(item => item.periodo));
        const totalPeriodos = periodos.size;
        const promedioMensual = totalPeriodos > 0 ? ventasNetas / totalPeriodos : 0;
        
        // Actualizar valores en UI
        document.getElementById('total-facturado').textContent = formatCurrency(totalFacturado);
        document.getElementById('total-facturado-subtitle').textContent = `${totalFacturasCount} documento${totalFacturasCount !== 1 ? 's' : ''}`;
        
        document.getElementById('total-nc').textContent = formatCurrency(totalNC);
        document.getElementById('total-nc-subtitle').textContent = `${totalNCCount} documento${totalNCCount !== 1 ? 's' : ''}`;
        
        document.getElementById('ventas-brutas').textContent = formatCurrency(ventasBrutas);
        document.getElementById('ventas-brutas-subtitle').textContent = `Después de descontar notas de crédito`;
        
        document.getElementById('ventas-netas').textContent = formatCurrency(ventasNetas);
        document.getElementById('ventas-netas-subtitle').textContent = `En ${totalPeriodos} ${totalPeriodos === 1 ? 'mes' : 'meses'} con facturación`;
        
        // Tendencias simuladas (solo para demostración)
        // En una implementación real, compararías con periodos anteriores
        const trendFacturado = Math.random() * 20 - 5; // Entre -5% y +15%
        const trendNC = Math.random() * 10 - 8; // Entre -8% y +2%
        const trendBruto = Math.random() * 15 - 2; // Entre -2% y +13%
        const trendNeto = Math.random() * 25 - 5; // Entre -5% y +20%
        
        // Actualizar tendencias en UI
        updateTrend('trend-facturado', trendFacturado);
        updateTrend('trend-nc', trendNC);
        updateTrend('trend-bruto', trendBruto);
        updateTrend('trend-neto', trendNeto);
    }

    // Actualizar indicador de tendencia
    function updateTrend(elementId, value) {
        const element = document.getElementById(elementId);
        
        if (value > 0) {
            element.className = 'stat-trend trend-up';
            element.innerHTML = `<i class="fas fa-arrow-up trend-icon"></i> ${formatPercent(value)} vs. año anterior`;
        } else if (value < 0) {
            element.className = 'stat-trend trend-down';
            element.innerHTML = `<i class="fas fa-arrow-down trend-icon"></i> ${formatPercent(Math.abs(value))} vs. año anterior`;
        } else {
            element.className = 'stat-trend trend-neutral';
            element.innerHTML = `<i class="fas fa-equals trend-icon"></i> Sin cambios vs. año anterior`;
        }
    }

    // Implementar todas las funciones restantes para el Dashboard de Ventas
    // Estas son similares a las que tenías en el archivo original pero adaptadas
    // para trabajar con la nueva estructura y IDs

    // Actualizar gráfico de evolución de ventas
    function updateCharts() {
        // Preparar datos para gráfico de evolución
        // Agrupar por período (año-mes)
        const salesByPeriod = {};
        
        filteredData.forEach(item => {
            const period = item.periodo;
            
            if (!salesByPeriod[period]) {
                salesByPeriod[period] = {
                    ventasNetas: 0, // Usamos ventas netas (sin IVA)
                    count: 0,
                    year: item.anio,
                    month: parseInt(item.mes)
                };
            }
            
            // Ventas netas: montoNetoSinIVA + exento (sin IVA)
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            salesByPeriod[period].ventasNetas += ventaNeta;
            salesByPeriod[period].count++;
        });
        
        // Obtener períodos ordenados por año y mes
        const sortedPeriods = Object.keys(salesByPeriod).sort((a, b) => {
            const yearA = salesByPeriod[a].year;
            const yearB = salesByPeriod[b].year;
            const monthA = salesByPeriod[a].month;
            const monthB = salesByPeriod[b].month;
            
            if (yearA !== yearB) {
                return yearA - yearB;
            }
            return monthA - monthB;
        });
        
        // Agrupar por año para las etiquetas del eje X
        const years = [...new Set(sortedPeriods.map(period => salesByPeriod[period].year))].sort();
        
        // Crear datasets agrupados por año
        const datasets = [];
        const yearColors = {
            // Colores para cada año con transparencia
            2019: { line: 'rgba(85, 172, 238, 1)', fill: 'rgba(85, 172, 238, 0.1)' },
            2020: { line: 'rgba(255, 123, 0, 1)', fill: 'rgba(255, 123, 0, 0.1)' },
            2021: { line: 'rgba(75, 192, 192, 1)', fill: 'rgba(75, 192, 192, 0.1)' },
            2022: { line: 'rgba(153, 102, 255, 1)', fill: 'rgba(153, 102, 255, 0.1)' },
            2023: { line: 'rgba(255, 205, 86, 1)', fill: 'rgba(255, 205, 86, 0.1)' },
            2024: { line: 'rgba(255, 99, 132, 1)', fill: 'rgba(255, 99, 132, 0.1)' },
            2025: { line: 'rgba(54, 162, 235, 1)', fill: 'rgba(54, 162, 235, 0.1)' }
        };
        
        // Para cada año, crear un dataset separado
        years.forEach(year => {
            // Datos para todos los meses (incluso los que no tienen ventas)
            const yearData = Array(12).fill(0);
            
            // Llenar con datos reales
            sortedPeriods.forEach(period => {
                if (salesByPeriod[period].year === year) {
                    const month = salesByPeriod[period].month - 1; // 0-based index
                    yearData[month] = salesByPeriod[period].ventasNetas;
                }
            });
            
            // Asignar color
            const yearColor = yearColors[year] || { 
                line: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`,
                fill: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.1)`
            };
            
            // Agregar dataset para este año
            datasets.push({
                label: `${year}`,
                data: yearData,
                backgroundColor: yearColor.fill,
                borderColor: yearColor.line,
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        });
        
        // Crear el gráfico
        const salesCtx = document.getElementById('salesChart-ventas').getContext('2d');
        
        if (salesChart) {
            salesChart.destroy();
        }
        
        // Crear etiquetas para los meses 
        const monthLabels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '$' + value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const datasetIndex = tooltipItems[0].datasetIndex;
                                const itemIndex = tooltipItems[0].dataIndex;
                                const year = datasets[datasetIndex].label;
                                const month = monthLabels[itemIndex];
                                return `${month} ${year}`;
                            },
                            label: function(context) {
                                return 'Ventas Netas: ' + formatCurrency(context.raw);
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 10
                        }
                    }
                }
            }
        });
        
        // Crear gráfico de distribución (pie)
        const distributionCtx = document.getElementById('distributionChart-ventas').getContext('2d');
        
        // Calcular totales por cliente (solo valores netos sin IVA)
        const clientTotals = {};
        filteredData.forEach(item => {
            if (!clientTotals[item.razonSocial]) {
                clientTotals[item.razonSocial] = 0;
            }
            
            // Ventas netas: montoNetoSinIVA + exento (sin IVA)
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            clientTotals[item.razonSocial] += ventaNeta;
        });
        
        // Ordenar clientes por monto total (de mayor a menor)
        const sortedClients = Object.keys(clientTotals)
            .sort((a, b) => clientTotals[b] - clientTotals[a]);
        
        // Tomar los 5 principales y agrupar el resto
        const topClients = sortedClients.slice(0, 5);
        const otherClients = sortedClients.slice(5);
        
        const pieLabels = topClients.map(client => truncateText(client, 15));
        const pieData = topClients.map(client => clientTotals[client]);
        
        // Agregar "Otros" si hay más clientes
        if (otherClients.length > 0) {
            const otherTotal = otherClients.reduce((sum, client) => sum + clientTotals[client], 0);
            pieLabels.push('Otros');
            pieData.push(otherTotal);
        }
        
        // Colores para el gráfico
        const pieColors = [
            'rgba(54, 162, 235, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)',
            'rgba(56, 103, 214, 0.8)'
        ];
        
        if (distributionChart) {
            distributionChart.destroy();
        }
        
        distributionChart = new Chart(distributionCtx, {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: pieColors,
                    borderColor: pieColors.map(color => color.replace('0.8', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value * 100) / total).toFixed(1);
                                return `${formatCurrency(value)} (${percentage}%)`;
                            },
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                if (index < topClients.length) {
                                    return topClients[index]; // Muestra el nombre completo en el tooltip
                                }
                                return 'Otros';
                            }
                        }
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15
                        }
                    }
                }
            }
        });
    }

    // Actualizar mapa de calor
    function updateHeatmap() {
        const heatmapTable = document.getElementById('heatmap-table-ventas');
        heatmapTable.innerHTML = '';
        
        // Agrupar ventas por año y mes
        const ventasPorPeriodo = {};
        const años = [];
        const meses = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
        const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        // Recopilar todos los años presentes en los datos filtrados
        filteredData.forEach(item => {
            if (!años.includes(item.anio)) {
                años.push(item.anio);
            }
            
            const key = `${item.anio}-${item.mes}`;
            if (!ventasPorPeriodo[key]) {
                ventasPorPeriodo[key] = 0;
            }
            
            // Ventas netas: montoNetoSinIVA + exento (sin IVA)
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            ventasPorPeriodo[key] += ventaNeta;
        });
        
        // Ordenar años descendentemente
        años.sort((a, b) => b - a);
        
        if (años.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="13" class="empty-state">
                    <div class="empty-icon"><i class="fas fa-calendar-times"></i></div>
                    <div class="empty-title">No hay datos disponibles</div>
                    <div class="empty-message">No se encontraron registros para generar el mapa de calor.</div>
                </td>
            `;
            heatmapTable.appendChild(emptyRow);
            return;
        }
        
        // Encontrar valor máximo para escala de color
        let maxVenta = 0;
        for (const key in ventasPorPeriodo) {
            if (ventasPorPeriodo[key] > maxVenta) {
                maxVenta = ventasPorPeriodo[key];
            }
        }
        
        // Crear cabecera de la tabla
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        // Celda de esquina
        const cornerCell = document.createElement('th');
        cornerCell.textContent = 'Año / Mes';
        headerRow.appendChild(cornerCell);
        
        // Meses en el encabezado
        meses.forEach((mes, index) => {
            const th = document.createElement('th');
            th.textContent = nombresMeses[index];
            headerRow.appendChild(th);
        });
        
        // Columna de total anual
        const totalHeader = document.createElement('th');
        totalHeader.textContent = 'Total Anual';
        headerRow.appendChild(totalHeader);
        
        thead.appendChild(headerRow);
        heatmapTable.appendChild(thead);
        
        // Crear cuerpo de la tabla
        const tbody = document.createElement('tbody');
        
        // Para cada año
        años.forEach(año => {
            const row = document.createElement('tr');
            
            // Celda con el año
            const yearCell = document.createElement('th');
            yearCell.textContent = año;
            row.appendChild(yearCell);
            
            // Variables para total anual
            let totalAnual = 0;
            let mesesConDatos = 0;
            
            // Para cada mes
            meses.forEach(mes => {
                const key = `${año}-${mes}`;
                const valor = ventasPorPeriodo[key] || 0;
                totalAnual += valor;
                
                if (valor > 0) mesesConDatos++;
                
                // Calcular intensidad para el color (0 a 100)
                const intensidad = maxVenta > 0 ? (valor / maxVenta * 100) : 0;
                
                const cell = document.createElement('td');
                cell.className = 'heatmap-cell';
                
                // Aplicar color de fondo según intensidad
                if (valor > 0) {
                    // Escala de color: azul claro a azul oscuro
                    const colorValue = Math.floor(255 - intensidad * 1.5);
                    cell.style.backgroundColor = `rgba(10, 61, 98, ${intensidad / 100})`;
                    cell.style.color = intensidad > 50 ? 'white' : 'inherit';
                }
                
                // Agregar valor formateado
                cell.innerHTML = `<div class="heatmap-value">${valor > 0 ? formatCurrency(valor) : ''}</div>`;
                
                row.appendChild(cell);
            });
            
            // Agregar celda de total anual
            const totalCell = document.createElement('td');
            totalCell.className = 'heatmap-cell';
            totalCell.style.backgroundColor = 'rgba(10, 61, 98, 0.1)';
            totalCell.style.fontWeight = 'bold';
            
            totalCell.innerHTML = `
                <div class="heatmap-value">${formatCurrency(totalAnual)}</div>
                <div style="font-size: 11px; color: var(--text-secondary);">${mesesConDatos} mes(es)</div>
            `;
            
            row.appendChild(totalCell);
            tbody.appendChild(row);
        });
        
        // Agregar fila de totales mensuales
        const totalsRow = document.createElement('tr');
        const totalsHeader = document.createElement('th');
        totalsHeader.textContent = 'Prom. Mensual';
        totalsRow.appendChild(totalsHeader);
        
        let granTotal = 0;
        
        // Calcular promedio mensual para cada mes
        meses.forEach(mes => {
            let totalMes = 0;
            let añosConDatos = 0;
            
            años.forEach(año => {
                const key = `${año}-${mes}`;
                const valor = ventasPorPeriodo[key] || 0;
                if (valor > 0) {
                    totalMes += valor;
                    añosConDatos++;
                    granTotal += valor;
                }
            });
            
            const promedioMes = añosConDatos > 0 ? totalMes / añosConDatos : 0;
            
            const cell = document.createElement('td');
            cell.className = 'heatmap-cell';
            cell.style.backgroundColor = 'rgba(246, 185, 59, 0.1)';
            cell.style.fontWeight = 'bold';
            
            cell.innerHTML = `
                <div class="heatmap-value">${promedioMes > 0 ? formatCurrency(promedioMes) : ''}</div>
                <div style="font-size: 11px; color: var(--text-secondary);">${añosConDatos} año(s)</div>
            `;
            
            totalsRow.appendChild(cell);
        });
        
        // Agregar celda de promedio general
        const avgTotalCell = document.createElement('td');
        avgTotalCell.className = 'heatmap-cell';
        avgTotalCell.style.backgroundColor = 'rgba(246, 185, 59, 0.2)';
        avgTotalCell.style.fontWeight = 'bold';
        
        const totalCeldas = Object.keys(ventasPorPeriodo).length;
        const promedioGeneral = totalCeldas > 0 ? granTotal / totalCeldas : 0;
        
        avgTotalCell.innerHTML = `
            <div class="heatmap-value">${formatCurrency(promedioGeneral)}</div>
            <div style="font-size: 11px; color: var(--text-secondary);">Promedio general</div>
        `;
        
        totalsRow.appendChild(avgTotalCell);
        tbody.appendChild(totalsRow);
        
        heatmapTable.appendChild(tbody);
    }

    // Actualizar gráfico de comparación anual
    function updateYearlyComparison() {
        // Agrupar por año
        const yearlyData = {};
        
        filteredData.forEach(item => {
            const year = item.anio;
            
            if (!yearlyData[year]) {
                yearlyData[year] = {
                    ventasNetas: 0,
                    count: 0
                };
            }
            
            // Ventas netas: montoNetoSinIVA + exento (sin IVA)
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            yearlyData[year].ventasNetas += ventaNeta;
            yearlyData[year].count++;
        });
        
        // Ordenar años
        const sortedYears = Object.keys(yearlyData).sort();
        
        // Preparar datos para el gráfico
        const yearLabels = sortedYears;
        const yearlyVentas = sortedYears.map(year => yearlyData[year].ventasNetas);
        const yearlyCount = sortedYears.map(year => yearlyData[year].count);
        
        // Encontrar el valor máximo para escalar el eje Y adecuadamente
        const maxValue = Math.max(...yearlyVentas);
        
        // Calcular un límite superior adecuado (redondeado hacia arriba)
        const yAxisMax = Math.ceil(maxValue * 1.1 / 1000000) * 1000000;
        
        // Crear gráfico
        const ctx = document.getElementById('yearlyComparisonChart-ventas').getContext('2d');
        
        if (yearlyComparisonChart) {
            yearlyComparisonChart.destroy();
        }
        
        yearlyComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: yearLabels,
                datasets: [
                    {
                        label: 'Ventas Netas',
                        data: yearlyVentas,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Cantidad de Documentos',
                        data: yearlyCount,
                        type: 'line',
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        pointStyle: 'circle',
                        pointRadius: 6,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: yAxisMax > 0 ? yAxisMax : undefined,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '$' + value;
                            }
                        },
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Ventas Netas (sin IVA)'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Documentos'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.label === 'Ventas Netas') {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                } else {
                                    return context.dataset.label + ': ' + context.raw;
                                }
                            }
                        }
                    },
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    // Actualizar comparativo mensual
    function updateMonthlyComparison() {
        // Agrupar ventas por mes
        const ventasPorMes = {};
        const ventas = {};
        const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        for (let i = 1; i <= 12; i++) {
            const mesStr = i.toString().padStart(2, '0');
            ventasPorMes[mesStr] = {
                ventasNetas: 0,
                count: 0,
                nombre: mesesNombres[i-1]
            };
        }
        
        // Calcular ventas por mes (usando ventas netas sin IVA)
        filteredData.forEach(item => {
            const mes = item.mes;
            
            if (!ventasPorMes[mes]) {
                ventasPorMes[mes] = {
                    ventasNetas: 0,
                    count: 0,
                    nombre: mesesNombres[parseInt(mes)-1]
                };
            }
            
            // Ventas netas: montoNetoSinIVA + exento (sin IVA)
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            ventasPorMes[mes].ventasNetas += ventaNeta;
            ventasPorMes[mes].count++;
        });
        
        // Preparar datos para el gráfico
        const labels = Object.keys(ventasPorMes)
            .sort((a, b) => parseInt(a) - parseInt(b))
            .map(mes => ventasPorMes[mes].nombre);
        
        const data = Object.keys(ventasPorMes)
            .sort((a, b) => parseInt(a) - parseInt(b))
            .map(mes => ventasPorMes[mes].ventasNetas);
        
        // Crear el gráfico
        const ctx = document.getElementById('monthlyComparisonChart-ventas').getContext('2d');
        
        if (monthlyComparisonChart) {
            monthlyComparisonChart.destroy();
        }
        
        // Colores para las barras según el valor (gradiente)
        const colors = [];
        const maxValue = Math.max(...data);
        
        data.forEach(value => {
            const intensity = maxValue > 0 ? value / maxValue : 0;
            colors.push(`rgba(10, 61, 98, ${0.3 + intensity * 0.6})`);
        });
        
        monthlyComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas Netas por Mes (sin IVA)',
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('rgba', 'rgb').replace(/, [\d.]+\)/, ')')),
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const index = context.dataIndex;
                                const mes = Object.keys(ventasPorMes).sort((a, b) => parseInt(a) - parseInt(b))[index];
                                const count = ventasPorMes[mes].count;
                                return [
                                    `Ventas Netas: ${formatCurrency(value)}`,
                                    `Documentos: ${count}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '$' + value;
                            }
                        },
                        title: {
                            display: true,
                            text: 'Ventas Netas (sin IVA)'
                        }
                    }
                }
            }
        });
    }

    // Actualizar gráfico de promedios mensuales por año
    function updateMonthlyAverages() {
        // Calcular promedios mensuales por año
        const yearlyData = {};
        
        // Agrupar ventas por año y mes
        filteredData.forEach(item => {
            const year = item.anio;
            const month = item.mes;
            const period = `${year}-${month}`;
            
            if (!yearlyData[year]) {
                yearlyData[year] = {
                    total: 0,
                    periods: new Set(),
                    monthlyData: {}
                };
            }
            
            if (!yearlyData[year].monthlyData[month]) {
                yearlyData[year].monthlyData[month] = {
                    ventasNetas: 0
                };
            }
            
            // Ventas netas: montoNetoSinIVA + exento (sin IVA)
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            yearlyData[year].monthlyData[month].ventasNetas += ventaNeta;
            
            yearlyData[year].periods.add(period);
        });
        
        // Calcular promedios
        Object.keys(yearlyData).forEach(year => {
            const yearData = yearlyData[year];
            
            // Calcular total por año
            let yearTotal = 0;
            Object.keys(yearData.monthlyData).forEach(month => {
                const monthData = yearData.monthlyData[month];
                yearTotal += monthData.ventasNetas;
            });
            
            yearData.total = yearTotal;
            yearData.periodCount = yearData.periods.size;
            yearData.average = yearData.periodCount > 0 ? yearTotal / yearData.periodCount : 0;
        });
        
        // Ordenar años
        const sortedYears = Object.keys(yearlyData).sort();
        
        // Preparar datos para el gráfico
        const yearLabels = sortedYears;
        const averageData = sortedYears.map(year => yearlyData[year].average);
        const periodCounts = sortedYears.map(year => yearlyData[year].periodCount);
        
        // Crear gráfico
        const ctx = document.getElementById('monthlyAverageChart-ventas').getContext('2d');
        
        if (monthlyAverageChart) {
            monthlyAverageChart.destroy();
        }
        
        monthlyAverageChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: yearLabels,
                datasets: [
                    {
                        label: 'Promedio Mensual (sin IVA)',
                        data: averageData,
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Meses con Actividad',
                        data: periodCounts,
                        type: 'line',
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        pointStyle: 'rectRot',
                        pointRadius: 6,
                        fill: false,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '$' + value;
                            }
                        },
                        title: {
                            display: true,
                            text: 'Pesos (sin IVA)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        max: 12, // Máximo 12 meses
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Meses'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.label.includes('Promedio')) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                } else {
                                    return context.dataset.label + ': ' + context.raw + ' ' + (context.raw === 1 ? 'mes' : 'meses');
                                }
                            }
                        }
                    },
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    // Actualizar métricas clave
    function updateKeyMetrics() {
        const metricsContainer = document.getElementById('key-metrics-container-ventas');
        metricsContainer.innerHTML = '';
        
        // 1. Análisis por día de la semana (usando valores sin IVA)
        const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        const ventasPorDia = Array(7).fill(0);
        const countPorDia = Array(7).fill(0);
        
        filteredData.forEach(item => {
            // Ventas netas: montoNetoSinIVA + exento (sin IVA)
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            ventasPorDia[item.diaSemana] += ventaNeta;
            countPorDia[item.diaSemana]++;
        });
        
        // Encontrar el día con mayor venta
        let maxVentasDia = 0;
        let maxVentasDiaIndex = 0;
        
        ventasPorDia.forEach((venta, index) => {
            if (venta > maxVentasDia) {
                maxVentasDia = venta;
                maxVentasDiaIndex = index;
            }
        });
        
        // Crear métrica para el día con mayor venta
        if (maxVentasDia > 0) {
            const metricaDiaMasVentas = document.createElement('div');
            metricaDiaMasVentas.className = 'analysis-metric';
            metricaDiaMasVentas.innerHTML = `
                <div class="metric-title">Día con Mayor Venta</div>
                <div class="metric-value">${diasSemana[maxVentasDiaIndex]}</div>
                <div class="metric-info">${formatCurrency(maxVentasDia)} en ${countPorDia[maxVentasDiaIndex]} documento(s)</div>
            `;
            metricsContainer.appendChild(metricaDiaMasVentas);
        }
        
        // 2. Promedio por Factura (solo valores sin IVA)
        const totalDocs = filteredData.length;
        let totalVentasNetas = 0;
        
        filteredData.forEach(item => {
            // Ventas netas: montoNetoSinIVA + exento (sin IVA)
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            totalVentasNetas += ventaNeta;
        });
        
        const promedioFactura = totalDocs > 0 ? totalVentasNetas / totalDocs : 0;
        
        const metricaPromedioFactura = document.createElement('div');
        metricaPromedioFactura.className = 'analysis-metric';
        metricaPromedioFactura.innerHTML = `
            <div class="metric-title">Promedio por Documento</div>
            <div class="metric-value">${formatCurrency(promedioFactura)}</div>
            <div class="metric-info">basado en ${totalDocs} documento(s)</div>
        `;
        metricsContainer.appendChild(metricaPromedioFactura);
        
        // 3. Variación Anual (si hay varios años) - Usando valores sin IVA
        const anios = [...new Set(filteredData.map(item => item.anio))].sort();
        
        if (anios.length > 1) {
            // Calcular ventas por año
            const ventasPorAnio = {};
            
            anios.forEach(anio => {
                ventasPorAnio[anio] = 0;
                
                filteredData.filter(item => item.anio === anio).forEach(item => {
                    // Ventas netas: montoNetoSinIVA + exento (sin IVA)
                    const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
                    ventasPorAnio[anio] += ventaNeta;
                });
            });
            
            // Calcular variación entre último y penúltimo año
            const ultimoAnio = anios[anios.length - 1];
            const penultimoAnio = anios[anios.length - 2];
            
            const ventasUltimoAnio = ventasPorAnio[ultimoAnio];
            const ventasPenultimoAnio = ventasPorAnio[penultimoAnio];
            
            if (ventasPenultimoAnio > 0) {
                const variacion = ((ventasUltimoAnio - ventasPenultimoAnio) / ventasPenultimoAnio) * 100;
                
                const metricaVariacion = document.createElement('div');
                metricaVariacion.className = 'analysis-metric';
                metricaVariacion.innerHTML = `
                    <div class="metric-title">Variación Anual</div>
                    <div class="metric-value ${variacion >= 0 ? 'trend-up' : 'trend-down'}">
                        ${variacion >= 0 ? '+' : ''}${formatPercent(variacion)}
                    </div>
                    <div class="metric-info">${ultimoAnio} vs. ${penultimoAnio}</div>
                `;
                metricsContainer.appendChild(metricaVariacion);
            }
        }
        
        // 4. Concentración en Clientes Top 3 con nombres (usando valores sin IVA)
        if (filteredData.length > 0) {
            // Calcular ventas por cliente
            const ventasPorCliente = {};
            
            filteredData.forEach(item => {
                if (!ventasPorCliente[item.razonSocial]) {
                    ventasPorCliente[item.razonSocial] = 0;
                }
                
                // Ventas netas: montoNetoSinIVA + exento (sin IVA)
                const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
                ventasPorCliente[item.razonSocial] += ventaNeta;
            });
            
            // Ordenar clientes por monto
            const clientesOrdenados = Object.keys(ventasPorCliente)
                .sort((a, b) => ventasPorCliente[b] - ventasPorCliente[a]);
            
            // Tomar los 3 principales
            const top3Clientes = clientesOrdenados.slice(0, 3);
            const ventasTop3 = top3Clientes.reduce((sum, cliente) => sum + ventasPorCliente[cliente], 0);
            
            // Calcular porcentaje sobre el total
            const totalVentas = Object.values(ventasPorCliente).reduce((sum, venta) => sum + venta, 0);
            const concentracionTop3 = totalVentas > 0 ? (ventasTop3 / totalVentas * 100) : 0;
            
            // Crear nombres formateados para mostrar
            const nombresTop3 = top3Clientes.map((cliente, index) => {
                const nombreCorto = truncateText(cliente, 20);
                return `${index + 1}. ${nombreCorto}`;
            }).join('<br>');
            
            const metricaConcentracion = document.createElement('div');
            metricaConcentracion.className = 'analysis-metric';
            metricaConcentracion.innerHTML = `
                <div class="metric-title">Concentración Top 3</div>
                <div class="metric-value">${formatPercent(concentracionTop3)}</div>
                <div class="metric-info">de ventas en 3 principales clientes:<br>${nombresTop3}</div>
            `;
            metricsContainer.appendChild(metricaConcentracion);
        }
        
        // 5. Métrica de distribución Neto vs Exento
        const totalMontoNetoSinIVA = filteredData.reduce((sum, item) => {
            const valor = item.esNotaCredito ? -item.montoNetoSinIVA : item.montoNetoSinIVA;
            return sum + valor;
        }, 0);
        
        const totalExento = filteredData.reduce((sum, item) => {
            const valor = item.esNotaCredito ? -item.exento : item.exento;
            return sum + valor;
        }, 0);
        
        const totalNeto = totalMontoNetoSinIVA + totalExento;
        
        if (totalNeto > 0) {
            const pctNeto = (totalMontoNetoSinIVA / totalNeto) * 100;
            const pctExento = (totalExento / totalNeto) * 100;
            
            const metricaDistribucion = document.createElement('div');
            metricaDistribucion.className = 'analysis-metric';
            metricaDistribucion.innerHTML = `
                <div class="metric-title">Distribución de Ventas Netas</div>
                <div class="metric-value">Afecto: ${formatPercent(pctNeto)}</div>
                <div class="metric-info">
                    Exento: ${formatPercent(pctExento)} | 
                    Total: ${formatCurrency(totalNeto)}
                </div>
            `;
            metricsContainer.appendChild(metricaDistribucion);
        }
    }

    // Actualizar sección de top clientes
    function updateTopClients() {
        const clientsContainer = document.getElementById('clients-container-ventas');
        clientsContainer.innerHTML = '';
        
        // Agrupar por cliente
        const clientData = {};
        filteredData.forEach(item => {
            if (!clientData[item.razonSocial]) {
                clientData[item.razonSocial] = {
                    total: 0,
                    facturas: 0,
                    rut: item.rut
                };
            }
            
            // Ventas netas sin IVA
            const ventaNeta = item.esNotaCredito ? -(item.montoNetoSinIVA + item.exento) : (item.montoNetoSinIVA + item.exento);
            clientData[item.razonSocial].total += ventaNeta;
            clientData[item.razonSocial].facturas++;
        });
        
        // Ordenar y obtener top 3
        const topClients = Object.keys(clientData)
            .sort((a, b) => clientData[b].total - clientData[a].total)
            .slice(0, 3);
        
        // Calcular el total para los porcentajes
        const totalVentas = topClients.reduce((sum, client) => sum + clientData[client].total, 0);
        
        // Crear tarjetas
        topClients.forEach((client, index) => {
            const data = clientData[client];
            const percentage = totalVentas > 0 ? (data.total / totalVentas * 100) : 0;
            
            const card = document.createElement('div');
            card.className = 'client-card';
            card.style.position = 'relative';
            
            const rank = document.createElement('div');
            rank.className = 'client-rank';
            rank.textContent = index + 1;
            
            // Truncar nombre para mostrar
            const truncatedName = truncateText(client, 30);
            
            const name = document.createElement('div');
            name.className = 'client-name';
            name.title = client; // Tooltip para nombres largos
            name.textContent = truncatedName;
            
            const info = document.createElement('div');
            info.className = 'client-info';
            info.textContent = `${data.facturas} documento${data.facturas !== 1 ? 's' : ''}`;
            
            // Añadir RUT si está disponible
            if (data.rut && data.rut !== 'N/A') {
                const rutInfo = document.createElement('div');
                rutInfo.className = 'client-info';
                rutInfo.innerHTML = `<strong>RUT:</strong> ${data.rut}`;
                info.appendChild(rutInfo);
            }
            
            const amount = document.createElement('div');
            amount.className = 'client-amount';
            amount.textContent = formatCurrency(data.total);
            
            const progress = document.createElement('div');
            progress.className = 'client-progress';
            
            const progressBar = document.createElement('div');
            progressBar.className = 'client-progress-bar';
            progressBar.style.width = `${percentage}%`;
            
            progress.appendChild(progressBar);
            
            const percentText = document.createElement('div');
            percentText.className = 'client-info';
            percentText.textContent = `${formatPercent(percentage)} del total`;
            
            card.appendChild(rank);
            card.appendChild(name);
            card.appendChild(info);
            card.appendChild(amount);
            card.appendChild(percentText);
            card.appendChild(progress);
            
            clientsContainer.appendChild(card);
        });
        
        // Si no hay clientes, mostrar mensaje
        if (topClients.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.innerHTML = `
                <div class="empty-icon"><i class="fas fa-users-slash"></i></div>
                <div class="empty-title">No hay datos de clientes</div>
                <div class="empty-message">No se encontraron clientes con los filtros actuales.</div>
            `;
            emptyState.style.gridColumn = '1 / -1';
            clientsContainer.appendChild(emptyState);
        }
    }

    // Actualizar tabla de facturas
    function updateTable() {
        invoiceTableBody.innerHTML = '';
        
        // Calcular total de páginas
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        
        // Ajustar página actual si es necesario
        if (currentPage > totalPages) {
            currentPage = totalPages > 0 ? totalPages : 1;
        }
        
        // Calcular índices para paginación
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
        
        // Obtener datos para la página actual
        const pageData = filteredData.slice(startIndex, endIndex);
        
        // Generar filas de la tabla
        pageData.forEach(item => {
            const row = document.createElement('tr');
            
            // Formatear fecha
            const fechaFormateada = item.fecha.toLocaleDateString('es-CL');
            
            // Determinar si es una factura o nota de crédito para formateo visual
            const isNC = item.esNotaCredito;
            
            // Truncar nombre del cliente para mostrar
            const clienteTruncado = truncateText(item.razonSocial, 30);
            
            row.innerHTML = `
                <td>${item.folio}</td>
                <td>${fechaFormateada}</td>
                <td title="${item.razonSocial}"><span class="truncate-text">${clienteTruncado}</span></td>
                <td>${formatCurrency(item.montoNetoSinIVA)}</td>
                <td>${formatCurrency(item.exento)}</td>
                <td>${formatCurrency(item.totalConIVA)}</td>
                <td style="${isNC ? 'font-weight: bold; color: var(--danger);' : ''}">${formatCurrency(item.montoNC)}</td>
                <td style="${item.montoNeto < 0 ? 'color: var(--danger);' : 'color: var(--success);'}">${formatCurrency(item.montoNeto)}</td>
            `;
            
            // Agregar clase visual según tipo de documento
            if (isNC) {
                row.style.backgroundColor = 'rgba(255, 99, 132, 0.05)';
            }
            
            invoiceTableBody.appendChild(row);
        });
        
        // Generar paginación
        updatePagination(totalPages);
        
        // Mostrar mensaje si no hay datos
        if (pageData.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="8">
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-file-invoice"></i></div>
                        <div class="empty-title">No se encontraron documentos</div>
                        <div class="empty-message">No hay facturas o notas de crédito que coincidan con los filtros actuales.</div>
                    </div>
                </td>
            `;
            invoiceTableBody.appendChild(emptyRow);
        }
    }

    // Actualizar controles de paginación
    function updatePagination(totalPages) {
        pagination.innerHTML = '';
        
        if (totalPages <= 1) {
            return;
        }
        
        // Texto informativo
        const infoText = document.createElement('span');
        infoText.style.marginRight = 'auto';
        infoText.style.fontSize = '14px';
        infoText.style.color = 'var(--text-secondary)';
        
        const startItem = (currentPage - 1) * rowsPerPage + 1;
        const endItem = Math.min(startItem + rowsPerPage - 1, filteredData.length);
        infoText.textContent = `Mostrando ${startItem}-${endItem} de ${filteredData.length} documentos`;
        
        pagination.appendChild(infoText);
        
        // Botón anterior
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerHTML = '&laquo;';
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        });
        pagination.appendChild(prevBtn);
        
        // Botones de página
        // Mostrar páginas: primera, actual -1, actual, actual +1, última
        const pageNumbers = new Set();
        pageNumbers.add(1); // Primera página
        pageNumbers.add(totalPages); // Última página
        
        if (currentPage > 1) pageNumbers.add(currentPage - 1);
        pageNumbers.add(currentPage);
        if (currentPage < totalPages) pageNumbers.add(currentPage + 1);
        
        const sortedPages = [...pageNumbers].sort((a, b) => a - b);
        
        let prevPage = 0;
        sortedPages.forEach(page => {
            // Agregar elipsis si hay saltos
            if (page - prevPage > 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                ellipsis.style.cursor = 'default';
                pagination.appendChild(ellipsis);
            }
            
            // Botón de página
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${page === currentPage ? 'active-page' : ''}`;
            pageBtn.textContent = page;
            pageBtn.addEventListener('click', () => {
                currentPage = page;
                updateTable();
            });
            pagination.appendChild(pageBtn);
            
            prevPage = page;
        });
        
        // Botón siguiente
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerHTML = '&raquo;';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        });
        pagination.appendChild(nextBtn);
    }

    // Cargar datos automáticamente al inicializar
    fetchData();
}
</script>




<script>
// Función de inicialización para el Dashboard de Compras
function initializeComprasDashboard() {
    // Insertar el contenido HTML en el contenedor
    document.getElementById('compras-dashboard').innerHTML = `
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title"><i class="fas fa-chart-line"></i> Dashboard de Compras</h1>
                <div class="dashboard-controls">
                    <button id="load-button-compras" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> Actualizar Datos
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filter-container">
                <div class="filter-item">
                    <span class="filter-label">Año</span>
                    <select id="year-filter-compras" class="filter-select" multiple="multiple">
                        <!-- Opciones generadas dinámicamente -->
                    </select>
                </div>
                <div class="filter-item">
                    <span class="filter-label">Mes</span>
                    <select id="month-filter-compras" class="filter-select" multiple="multiple">
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="filter-item">
                    <span class="filter-label">Proveedor</span>
                    <select id="proveedor-filter-compras" class="filter-select" multiple="multiple">
                        <!-- Opciones generadas dinámicamente -->
                    </select>
                </div>
                <div class="filter-item">
                    <span class="filter-label">Tipo de Documento</span>
                    <select id="tipo-doc-filter-compras" class="filter-select" multiple="multiple">
                        <!-- Opciones generadas dinámicamente -->
                    </select>
                </div>
                <div class="filter-item">
                    <span class="filter-label">Acciones</span>
                    <button id="reset-filters-compras" class="btn btn-outline btn-block">
                        <i class="fas fa-filter"></i> Limpiar Filtros
                    </button>
                </div>
            </div>

            <!-- Mensaje de error y carga -->
            <div id="loading-message-compras" class="loader-container hidden">
                <div class="loader"></div>
            </div>
            <div id="error-message-compras" class="error-message"></div>

            <!-- Tarjetas de Estadísticas -->
            <div id="stats-container-compras" class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">Total Compras (con IVA)</div>
                    <div id="total-compras" class="stat-value">$0</div>
                    <div id="total-compras-subtitle" class="stat-subtitle">0 documentos</div>
                    <div id="trend-compras" class="stat-trend trend-up">
                        <i class="fas fa-arrow-up trend-icon"></i> 0% vs. año anterior
                    </div>
                    <i class="fas fa-file-invoice-dollar stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Notas de Crédito</div>
                    <div id="total-nc-compras" class="stat-value">$0</div>
                    <div id="total-nc-subtitle-compras" class="stat-subtitle">0 documentos</div>
                    <div id="trend-nc-compras" class="stat-trend trend-down">
                        <i class="fas fa-arrow-down trend-icon"></i> 0% vs. año anterior
                    </div>
                    <i class="fas fa-file-medical stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Monto Neto</div>
                    <div id="monto-neto" class="stat-value">$0</div>
                    <div id="monto-neto-subtitle" class="stat-subtitle">0% del total comprado</div>
                    <div id="trend-neto-compras" class="stat-trend trend-up">
                        <i class="fas fa-arrow-up trend-icon"></i> 0% vs. año anterior
                    </div>
                    <i class="fas fa-shopping-basket stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">IVA Total</div>
                    <div id="total-iva" class="stat-value">$0</div>
                    <div id="total-iva-subtitle" class="stat-subtitle">Calculado</div>
                    <div id="trend-iva" class="stat-trend trend-neutral">
                        <i class="fas fa-equals trend-icon"></i> Comparativa mensual
                    </div>
                    <i class="fas fa-percentage stat-icon"></i>
                </div>
            </div>

            <!-- Comparativo Anual -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> Análisis Comparativo</h2>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Comparativo de Compras Anuales</h3>
                            <p class="chart-subtitle">Visualización de montos netos y totales por año</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="yearlyComparisonChart-compras"></canvas>
                    </div>
                </div>
            </div>

            <!-- Evolución de Compras -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-line"></i> Evolución Mensual</h2>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Evolución de Compras por Mes</h3>
                            <p class="chart-subtitle">Tendencias de compras mensuales agrupadas por año</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="purchaseChart-compras"></canvas>
                    </div>
                </div>
            </div>

            <!-- Análisis de Tipos de Documentos y Distribución -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-pie"></i> Análisis de Distribución</h2>
                </div>
                <div class="chart-grid">
                    <div class="chart-grid-item">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Distribución por Tipo de Documento</h3>
                            </div>
                            <div class="chart-container" style="height: 300px">
                                <canvas id="docTypeChart-compras"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-grid-item">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Distribución por Proveedor</h3>
                            </div>
                            <div class="chart-container" style="height: 300px">
                                <canvas id="proveedorChart-compras"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Análisis Avanzado -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-brain"></i> Análisis Avanzado</h2>
                </div>
                <div class="analysis-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Métricas Clave de Rendimiento</h3>
                    </div>
                    <div class="analysis-grid" id="key-metrics-container-compras">
                        <!-- Métricas generadas dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Top Proveedores -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-building"></i> Top 3 Proveedores</h2>
                </div>
                <div id="proveedores-container-compras" class="clients-container"></div>
            </div>

            <!-- Tabla de Compras -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-table"></i> Detalle de Documentos</h2>
                </div>
                
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">Registro de Compras y Notas de Crédito</h3>
                        <div class="table-actions">
                            <select id="table-page-size-compras" class="filter-select">
                                <option value="10">10 por página</option>
                                <option value="25">25 por página</option>
                                <option value="50">50 por página</option>
                                <option value="100">100 por página</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th data-sort="folio">Folio <i class="fas fa-sort"></i></th>
                                    <th data-sort="fechaDocto">Fecha <i class="fas fa-sort"></i></th>
                                    <th data-sort="tipoDoc">Tipo Doc <i class="fas fa-sort"></i></th>
                                    <th data-sort="razonSocial">Proveedor <i class="fas fa-sort"></i></th>
                                    <th data-sort="montoNeto">Monto Neto <i class="fas fa-sort"></i></th>
                                    <th data-sort="montoExento">Exento <i class="fas fa-sort"></i></th>
                                    <th data-sort="montoIVA">IVA <i class="fas fa-sort"></i></th>
                                    <th data-sort="montoTotal">Total <i class="fas fa-sort"></i></th>
                                </tr>
                            </thead>
                            <tbody id="compras-table-body">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-compras" class="pagination">
                        <!-- Paginación se generará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    `;

    // Variables para gráficos de compras
    let purchaseChart;
    let docTypeChart;
    let proveedorChart;
    let yearlyComparisonChart;

    // Variables para datos
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let rowsPerPage = 10;
    let yearOptions = new Set();
    let proveedorOptions = new Set();
    let tipoDocOptions = new Set();

    // Variables para ordenamiento
    let currentSortColumn = 'fechaDocto';
    let currentSortDirection = 'desc';

    // URL del flujo
    const flowUrl = 'https://prod-133.westus.logic.azure.com:443/workflows/9ecb5bdf91a342ee9f722657534c4afa/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=d5r1enWX0S8V98f8Y5SbkZUX6xmB5-NwhxqV6Xxd7rc';

    // Referencias a elementos DOM específicos de compras
    const loadButton = document.getElementById('load-button-compras');
    const loadingMessage = document.getElementById('loading-message-compras');
    const errorMessage = document.getElementById('error-message-compras');
    const resetFiltersButton = document.getElementById('reset-filters-compras');
    const yearFilter = document.getElementById('year-filter-compras');
    const monthFilter = document.getElementById('month-filter-compras');
    const proveedorFilter = document.getElementById('proveedor-filter-compras');
    const tipoDocFilter = document.getElementById('tipo-doc-filter-compras');
    const comprasTableBody = document.getElementById('compras-table-body');
    const pagination = document.getElementById('pagination-compras');
    const tablePageSize = document.getElementById('table-page-size-compras');

    // Formateo de moneda
    function formatCurrency(value) {
        return new Intl.NumberFormat('es-CL', { 
            style: 'currency', 
            currency: 'CLP',
            maximumFractionDigits: 0
        }).format(value);
    }

    // Formateo de porcentaje
    function formatPercent(value) {
        return `${value.toFixed(1)}%`;
    }

    // Función para truncar texto largo
    function truncateText(text, maxLength = 20) {
        if (!text) return 'N/A';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Inicializar Select2 para filtros múltiples
    function initializeSelect2() {
        // Multiselect para años
        $(yearFilter).select2({
            placeholder: 'Seleccionar años',
            allowClear: true,
            closeOnSelect: false
        });
        
        // Multiselect para meses
        $(monthFilter).select2({
            placeholder: 'Seleccionar meses',
            allowClear: true,
            closeOnSelect: false
        });
        
        // Multiselect para proveedores
        $(proveedorFilter).select2({
            placeholder: 'Seleccionar proveedores',
            allowClear: true,
            closeOnSelect: false
        });
        
        // Multiselect para tipos de documento
        $(tipoDocFilter).select2({
            placeholder: 'Seleccionar tipo de documento',
            allowClear: true,
            closeOnSelect: false
        });
    }

    // Inicializar Select2
    initializeSelect2();

    // Evento para botón de carga
    loadButton.addEventListener('click', fetchData);

    // Eventos para filtros
    $(yearFilter).on('change', applyFilters);
    $(monthFilter).on('change', applyFilters);
    $(proveedorFilter).on('change', applyFilters);
    $(tipoDocFilter).on('change', applyFilters);
    resetFiltersButton.addEventListener('click', resetFilters);
    tablePageSize.addEventListener('change', function() {
        rowsPerPage = parseInt(this.value);
        currentPage = 1;
        updateTable();
    });

    // Configurar eventos de ordenamiento en encabezados de tabla
    document.querySelectorAll('#compras-dashboard .data-table th').forEach(th => {
        th.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            if (column) {
                if (currentSortColumn === column) {
                    // Cambiar dirección si es la misma columna
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // Nueva columna, establecer dirección por defecto
                    currentSortColumn = column;
                    currentSortDirection = 'asc';
                }
                updateSortIcons();
                sortData();
                updateTable();
            }
        });
    });

    // Actualizar iconos de ordenamiento
    function updateSortIcons() {
        document.querySelectorAll('#compras-dashboard .data-table th i').forEach(icon => {
            icon.className = 'fas fa-sort';
        });
        
        const currentHeader = document.querySelector(`#compras-dashboard .data-table th[data-sort="${currentSortColumn}"]`);
        if (currentHeader) {
            const icon = currentHeader.querySelector('i');
            if (icon) {
                icon.className = `fas fa-sort-${currentSortDirection === 'asc' ? 'up' : 'down'}`;
            }
        }
    }

    // Ordenar datos
    function sortData() {
        filteredData.sort((a, b) => {
            let valueA = a[currentSortColumn];
            let valueB = b[currentSortColumn];
            
            // Manejar diferentes tipos de datos
            if (currentSortColumn === 'fechaDocto') {
                valueA = new Date(valueA).getTime();
                valueB = new Date(valueB).getTime();
            } else if (typeof valueA === 'string') {
                valueA = valueA.toLowerCase();
                valueB = valueB.toLowerCase();
            }
            
            // Comparación basada en la dirección
            if (currentSortDirection === 'asc') {
                return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
            } else {
                return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
            }
        });
    }

    // Función para reiniciar filtros
    function resetFilters() {
        // Restablecer Select2
        $(yearFilter).val(null).trigger('change');
        $(monthFilter).val(null).trigger('change');
        $(proveedorFilter).val(null).trigger('change');
        $(tipoDocFilter).val(null).trigger('change');
        
        applyFilters();
        showToast('Filtros reiniciados correctamente', 'success');
    }

    // Mapear códigos de documentos a nombres
    function mapTipoDocumento(tipoDoc) {
        const tiposDoc = {
            33: 'Factura Electrónica',
            34: 'Factura Exenta Electrónica',
            61: 'Nota de Crédito Electrónica',
            56: 'Nota de Débito Electrónica',
            46: 'Factura de Compra Electrónica',
            43: 'Liquidación Factura Electrónica'
        };
        
        return tiposDoc[tipoDoc] || `Tipo ${tipoDoc}`;
    }

    // Función para obtener datos
    async function fetchData() {
        // Limpiar y mostrar carga
        resetUI();
        
        try {
            loadingMessage.classList.remove('hidden');
            loadButton.disabled = true;
            
            const response = await fetch(flowUrl);
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
            }
            
            const responseData = await response.json();
            
            // Verificar formato de respuesta y extraer el array de datos
            let data;
            if (responseData.body && Array.isArray(responseData.body)) {
                data = responseData.body;
            } else if (Array.isArray(responseData)) {
                data = responseData;
            } else {
                throw new Error('Formato de datos no reconocido');
            }
            
            if (!Array.isArray(data)) {
                throw new Error('La respuesta recibida no es un array');
            }
            
            // Procesar datos
            processData(data);
            showToast('Datos de compras cargados exitosamente', 'success');
            
        } catch (error) {
            console.error('Error al cargar datos:', error);
            errorMessage.textContent = `Error: ${error.message}`;
            showToast('Error al cargar datos de compras', 'error');
        } finally {
            loadingMessage.classList.add('hidden');
            loadButton.disabled = false;
        }
    }

    // Función para resetear la UI
    function resetUI() {
        errorMessage.textContent = '';
        // Eliminar gráficos existentes
        if (purchaseChart) purchaseChart.destroy();
        if (docTypeChart) docTypeChart.destroy();
        if (proveedorChart) proveedorChart.destroy();
        if (yearlyComparisonChart) yearlyComparisonChart.destroy();
        
        // Limpiar contenedores
        document.getElementById('proveedores-container-compras').innerHTML = '';
        document.getElementById('key-metrics-container-compras').innerHTML = '';
        comprasTableBody.innerHTML = '';
        pagination.innerHTML = '';
    }

    // Función para procesar datos recibidos
    function processData(data) {
        // Mapear datos a formato más conveniente
        allData = data.map(item => {
            // Procesar fecha
            let fechaDocto;
            try {
                // Adaptar a los nombres de campos de la nueva API
                const fechaStr = item['Fecha_x0020_Docto'] || '';
                fechaDocto = new Date(fechaStr);
                if (isNaN(fechaDocto.getTime())) { // Verificar si la fecha es válida
                    fechaDocto = new Date(); // Usar fecha actual como fallback
                }
            } catch (e) {
                fechaDocto = new Date();
            }
            
            // Determinar si es nota de crédito
            const tipoDoc = parseInt(item['Tipo_x0020_Doc'] || 0);
            const esNotaCredito = tipoDoc === 61;
            
            // Calcular valores
            const montoNeto = parseFloat(item['Monto_x0020_Neto'] || 0);
            const montoExento = parseFloat(item['Monto_x0020_Exento'] || 0);
            const montoTotal = parseFloat(item['Monto_x0020_Total'] || 0);
            
            // Calcular IVA como la diferencia entre total y (neto + exento)
            // Ya que IVA recuperable y no recuperable no están disponibles
            const montoIVA = montoTotal - (montoNeto + montoExento);
            
            const tipoDocName = mapTipoDocumento(tipoDoc);
            
            return {
                rutProveedor: item['RUT_x0020_Proveedor'] || 'N/A',
                razonSocial: item['Razon_x0020_Social'] || 'N/A',
                tipoDoc: tipoDoc,
                tipoDocName: tipoDocName,
                folio: item['Folio'] || 'N/A',
                fechaDocto: fechaDocto,
                montoExento: montoExento,
                montoNeto: montoNeto,
                montoIVA: montoIVA,
                montoTotal: montoTotal,
                anio: fechaDocto.getFullYear(),
                mes: String(fechaDocto.getMonth() + 1).padStart(2, '0'),
                dia: fechaDocto.getDate(),
                diaSemana: fechaDocto.getDay(),
                periodo: `${fechaDocto.getFullYear()}-${String(fechaDocto.getMonth() + 1).padStart(2, '0')}`,
                esNotaCredito: esNotaCredito
            };
        });
        
        // Extraer opciones para los filtros
        yearOptions = new Set(allData.map(item => item.anio));
        proveedorOptions = new Set(allData.filter(item => item.razonSocial !== 'N/A').map(item => item.razonSocial));
        tipoDocOptions = new Set(allData.map(item => item.tipoDocName));
        
        // Actualizar selectores de filtros
        updateFilterOptions();
        
        // Aplicar filtros (inicialmente muestra todo)
        applyFilters();
    }

    // Actualizar opciones de filtros
    function updateFilterOptions() {
        // Limpiar opciones actuales
        $(yearFilter).empty();
        $(proveedorFilter).empty();
        $(tipoDocFilter).empty();
        
        // Agregar años ordenados de más reciente a más antiguo
        [...yearOptions].sort((a, b) => b - a).forEach(year => {
            const option = new Option(year, year, false, false);
            $(yearFilter).append(option);
        });
        
        // Agregar proveedores ordenados alfabéticamente
        [...proveedorOptions].sort().forEach(proveedor => {
            if (proveedor) {
                const option = new Option(truncateText(proveedor, 40), proveedor, false, false);
                option.title = proveedor; // Tooltip para nombres largos
                $(proveedorFilter).append(option);
            }
        });
        
        // Agregar tipos de documento
        [...tipoDocOptions].sort().forEach(tipoDoc => {
            if (tipoDoc) {
                const option = new Option(tipoDoc, tipoDoc, false, false);
                $(tipoDocFilter).append(option);
            }
        });
        
        // Refrescar Select2
        $(yearFilter).trigger('change');
        $(monthFilter).trigger('change');
        $(proveedorFilter).trigger('change');
        $(tipoDocFilter).trigger('change');
    }

    // Aplicar filtros y actualizar visualización
    function applyFilters() {
        const selectedYears = $(yearFilter).val() || [];
        const selectedMonths = $(monthFilter).val() || [];
        const selectedProveedores = $(proveedorFilter).val() || [];
        const selectedTiposDoc = $(tipoDocFilter).val() || [];
        
        // Filtrar datos según selecciones
        filteredData = allData.filter(item => {
            return (
                (selectedYears.length === 0 || selectedYears.includes(item.anio.toString())) &&
                (selectedMonths.length === 0 || selectedMonths.includes(item.mes)) &&
                (selectedProveedores.length === 0 || selectedProveedores.includes(item.razonSocial)) &&
                (selectedTiposDoc.length === 0 || selectedTiposDoc.includes(item.tipoDocName))
            );
        });
        
        // Aplicar ordenamiento actual
        sortData();
        
        // Resetear a primera página
        currentPage = 1;
        
        // Actualizar visualizaciones
        updateStats();
        updateCharts();
        updateDocTypeDistribution();
        updateProveedorDistribution();
        updateYearlyComparison();
        updateTopProveedores();
        updateTable();
        updateKeyMetrics();
    }

    // Actualizar estadísticas principales
    function updateStats() {
        // Separar facturas y notas de crédito
        const facturas = filteredData.filter(item => !item.esNotaCredito);
        const notasCredito = filteredData.filter(item => item.esNotaCredito);
        
        // Calcular totales
        const totalCompras = facturas.reduce((sum, item) => sum + item.montoTotal, 0);
        const totalNC = notasCredito.reduce((sum, item) => sum + item.montoTotal, 0);
        
        // Calcular montos netos
        const totalMontoNeto = facturas.reduce((sum, item) => sum + item.montoNeto, 0) - 
                              notasCredito.reduce((sum, item) => sum + item.montoNeto, 0);
        
        // Calcular IVA
        const totalIVA = facturas.reduce((sum, item) => sum + item.montoIVA, 0) - 
                         notasCredito.reduce((sum, item) => sum + item.montoIVA, 0);
        
        // Contar documentos
        const totalFacturasCount = facturas.length;
        const totalNCCount = notasCredito.length;
        
        // Actualizar valores en UI
        document.getElementById('total-compras').textContent = formatCurrency(totalCompras);
        document.getElementById('total-compras-subtitle').textContent = `${totalFacturasCount} documento${totalFacturasCount !== 1 ? 's' : ''}`;
        
        document.getElementById('total-nc-compras').textContent = formatCurrency(totalNC);
        document.getElementById('total-nc-subtitle-compras').textContent = `${totalNCCount} documento${totalNCCount !== 1 ? 's' : ''}`;
        
        document.getElementById('monto-neto').textContent = formatCurrency(totalMontoNeto);
        document.getElementById('monto-neto-subtitle').textContent = `Neto total después de notas de crédito`;
        
        document.getElementById('total-iva').textContent = formatCurrency(totalIVA);
        document.getElementById('total-iva-subtitle').textContent = `IVA calculado`;
        
        // Simulación de tendencias
        const trendCompras = Math.random() * 20 - 5; // Entre -5% y 15%
        const trendNC = Math.random() * 10 - 8; // Entre -8% y 2%
        const trendNeto = Math.random() * 15 - 2; // Entre -2% y 13%
        const trendIVA = Math.random() * 12 - 6; // Entre -6% y 6%
        
        // Actualizar tendencias en UI
        updateTrend('trend-compras', trendCompras);
        updateTrend('trend-nc-compras', trendNC);
        updateTrend('trend-neto-compras', trendNeto);
        updateTrend('trend-iva', trendIVA);
    }

    // Actualizar indicador de tendencia
    function updateTrend(elementId, value) {
        const element = document.getElementById(elementId);
        
        if (value > 0) {
            element.className = 'stat-trend trend-up';
            element.innerHTML = `<i class="fas fa-arrow-up trend-icon"></i> ${formatPercent(value)} vs. año anterior`;
        } else if (value < 0) {
            element.className = 'stat-trend trend-down';
            element.innerHTML = `<i class="fas fa-arrow-down trend-icon"></i> ${formatPercent(Math.abs(value))} vs. año anterior`;
        } else {
            element.className = 'stat-trend trend-neutral';
            element.innerHTML = `<i class="fas fa-equals trend-icon"></i> Sin cambios vs. año anterior`;
        }
    }

    // Actualizar gráfico de evolución de compras
    function updateCharts() {
        // Preparar datos para gráfico de evolución
        // Agrupar por período (año-mes)
        const purchaseByPeriod = {};
        
        filteredData.forEach(item => {
            const period = item.periodo;
            
            if (!purchaseByPeriod[period]) {
                purchaseByPeriod[period] = {
                    montoNeto: 0,
                    count: 0,
                    year: item.anio,
                    month: parseInt(item.mes)
                };
            }
            
            // Para notas de crédito, restar el monto
            const montoNeto = item.esNotaCredito ? -item.montoNeto : item.montoNeto;
            purchaseByPeriod[period].montoNeto += montoNeto;
            purchaseByPeriod[period].count++;
        });
        
        // Obtener períodos ordenados por año y mes
        const sortedPeriods = Object.keys(purchaseByPeriod).sort((a, b) => {
            const yearA = purchaseByPeriod[a].year;
            const yearB = purchaseByPeriod[b].year;
            const monthA = purchaseByPeriod[a].month;
            const monthB = purchaseByPeriod[b].month;
            
            if (yearA !== yearB) {
                return yearA - yearB;
            }
            return monthA - monthB;
        });
        
        // Agrupar por año para las etiquetas del eje X
        const years = [...new Set(sortedPeriods.map(period => purchaseByPeriod[period].year))].sort();
        
        // Crear datasets agrupados por año
        const datasets = [];
        const yearColors = {
            2022: { line: 'rgba(59, 130, 246, 1)', fill: 'rgba(59, 130, 246, 0.1)' },
            2023: { line: 'rgba(139, 92, 246, 1)', fill: 'rgba(139, 92, 246, 0.1)' },
            2024: { line: 'rgba(16, 185, 129, 1)', fill: 'rgba(16, 185, 129, 0.1)' },
            2025: { line: 'rgba(245, 158, 11, 1)', fill: 'rgba(245, 158, 11, 0.1)' }
        };
        
        // Para cada año, crear un dataset separado
        years.forEach(year => {
            // Datos para todos los meses (incluso los que no tienen compras)
            const yearData = Array(12).fill(0);
            
            // Llenar con datos reales
            sortedPeriods.forEach(period => {
                if (purchaseByPeriod[period].year === year) {
                    const month = purchaseByPeriod[period].month - 1; // 0-based index
                    yearData[month] = purchaseByPeriod[period].montoNeto;
                }
            });
            
            // Asignar color
            const yearColor = yearColors[year] || { 
                line: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`,
                fill: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.1)`
            };
            
            // Agregar dataset para este año
            datasets.push({
                label: `${year}`,
                data: yearData,
                backgroundColor: yearColor.fill,
                borderColor: yearColor.line,
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6
            });
        });
        
        // Crear el gráfico
        const purchaseCtx = document.getElementById('purchaseChart-compras').getContext('2d');
        
        if (purchaseChart) {
            purchaseChart.destroy();
        }
        
        // Crear etiquetas para los meses 
        const monthLabels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        purchaseChart = new Chart(purchaseCtx, {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '$' + value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const datasetIndex = tooltipItems[0].datasetIndex;
                                const itemIndex = tooltipItems[0].dataIndex;
                                const year = datasets[datasetIndex].label;
                                const month = monthLabels[itemIndex];
                                return `${month} ${year}`;
                            },
                            label: function(context) {
                                return 'Monto Neto: ' + formatCurrency(context.raw);
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 10
                        }
                    }
                }
            }
        });
    }

    // Actualizar gráfico de distribución por tipo de documento
    function updateDocTypeDistribution() {
        const docTypeCtx = document.getElementById('docTypeChart-compras').getContext('2d');
        
        // Calcular totales por tipo de documento
        const tipoDocData = {};
        filteredData.forEach(item => {
            const tipoDoc = item.tipoDocName;
            
            if (!tipoDocData[tipoDoc]) {
                tipoDocData[tipoDoc] = {
                    count: 0,
                    monto: 0
                };
            }
            
            tipoDocData[tipoDoc].count++;
            tipoDocData[tipoDoc].monto += item.montoTotal;
        });
        
        // Preparar datos para el gráfico
        const labels = Object.keys(tipoDocData);
        const montos = labels.map(tipo => tipoDocData[tipo].monto);
        const counts = labels.map(tipo => tipoDocData[tipo].count);
        
        // Colores para el gráfico
        const backgroundColors = [
            'rgba(59, 130, 246, 0.7)',
            'rgba(16, 185, 129, 0.7)',
            'rgba(239, 68, 68, 0.7)',
            'rgba(245, 158, 11, 0.7)',
            'rgba(139, 92, 246, 0.7)'
        ];
        
        // Crear o actualizar gráfico
        if (docTypeChart) {
            docTypeChart.destroy();
        }
        
        docTypeChart = new Chart(docTypeCtx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Monto Total',
                    data: montos,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value * 100) / total).toFixed(1);
                                return [
                                    `Monto: ${formatCurrency(value)}`,
                                    `Porcentaje: ${percentage}%`,
                                    `Documentos: ${counts[context.dataIndex]}`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }

    // Actualizar gráfico de distribución por proveedor
    function updateProveedorDistribution() {
        const proveedorCtx = document.getElementById('proveedorChart-compras').getContext('2d');
        
        // Calcular totales por proveedor
        const proveedorTotals = {};
        filteredData.forEach(item => {
            if (!proveedorTotals[item.razonSocial]) {
                proveedorTotals[item.razonSocial] = 0;
            }
            
            // Para notas de crédito, restar el monto
            const montoNeto = item.esNotaCredito ? -item.montoNeto : item.montoNeto;
            proveedorTotals[item.razonSocial] += montoNeto;
        });
        
        // Ordenar proveedores por monto
        const sortedProveedores = Object.keys(proveedorTotals)
            .sort((a, b) => proveedorTotals[b] - proveedorTotals[a]);
        
        // Tomar los 5 principales y agrupar el resto
        const topProveedores = sortedProveedores.slice(0, 5);
        const otrosProveedores = sortedProveedores.slice(5);
        
        // Preparar datos para el gráfico
        const chartLabels = topProveedores.map(proveedor => truncateText(proveedor, 15));
        const chartData = topProveedores.map(proveedor => proveedorTotals[proveedor]);
        
        // Agregar categoría "Otros"
        if (otrosProveedores.length > 0) {
            const otrosTotal = otrosProveedores.reduce((sum, proveedor) => sum + proveedorTotals[proveedor], 0);
            chartLabels.push('Otros proveedores');
            chartData.push(otrosTotal);
        }
        
        // Colores para el gráfico
        const chartColors = [
            'rgba(59, 130, 246, 0.7)',
            'rgba(16, 185, 129, 0.7)',
            'rgba(245, 158, 11, 0.7)',
            'rgba(139, 92, 246, 0.7)',
            'rgba(14, 165, 233, 0.7)',
            'rgba(249, 115, 22, 0.7)'
        ];
        
        // Crear o actualizar gráfico
        if (proveedorChart) {
            proveedorChart.destroy();
        }
        
        proveedorChart = new Chart(proveedorCtx, {
            type: 'doughnut',
            data: {
                labels: chartLabels,
                datasets: [{
                    data: chartData,
                    backgroundColor: chartColors,
                    borderColor: chartColors.map(color => color.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value * 100) / total).toFixed(1);
                                return `${formatCurrency(value)} (${percentage}%)`;
                            },
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                if (index < topProveedores.length) {
                                    return topProveedores[index]; // Muestra el nombre completo en el tooltip
                                }
                                return 'Otros proveedores';
                            }
                        }
                    }
                }
            }
        });
    }

    // Actualizar gráfico de comparación anual
    function updateYearlyComparison() {
        // Agrupar por año
        const yearlyData = {};
        
        filteredData.forEach(item => {
            const year = item.anio;
            
            if (!yearlyData[year]) {
                yearlyData[year] = {
                    montoNeto: 0,
                    montoTotal: 0,
                    count: 0
                };
            }
            
            // Para notas de crédito, restar el monto
            const factor = item.esNotaCredito ? -1 : 1;
            yearlyData[year].montoNeto += item.montoNeto * factor;
            yearlyData[year].montoTotal += item.montoTotal * factor;
            yearlyData[year].count += factor;
        });
        
        // Ordenar años
        const sortedYears = Object.keys(yearlyData).sort();
        
        // Preparar datos para el gráfico
        const yearLabels = sortedYears;
        const montoNeto = sortedYears.map(year => yearlyData[year].montoNeto);
        const montoTotal = sortedYears.map(year => yearlyData[year].montoTotal);
        const yearlyCount = sortedYears.map(year => yearlyData[year].count);
        
        // Crear gráfico
        const ctx = document.getElementById('yearlyComparisonChart-compras').getContext('2d');
        
        if (yearlyComparisonChart) {
            yearlyComparisonChart.destroy();
        }
        
        yearlyComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: yearLabels,
                datasets: [
                    {
                        label: 'Monto Neto',
                        data: montoNeto,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        order: 2
                    },
                    {
                        label: 'Monto Total (con IVA)',
                        data: montoTotal,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        order: 1
                    },
                    {
                        label: 'Cantidad Documentos',
                        data: yearlyCount,
                        type: 'line',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        backgroundColor: 'rgba(245, 158, 11, 0.7)',
                        borderWidth: 2,
                        pointStyle: 'circle',
                        pointRadius: 6,
                        yAxisID: 'y1',
                        order: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Montos (CLP)'
                        },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '$' + value;
                            }
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Documentos'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.label.includes('Monto')) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                } else {
                                    return context.dataset.label + ': ' + context.raw;
                                }
                            }
                        }
                    },
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }

    // Actualizar sección de top proveedores
    function updateTopProveedores() {
        const proveedoresContainer = document.getElementById('proveedores-container-compras');
        proveedoresContainer.innerHTML = '';
        
        // Agrupar por proveedor
        const proveedorData = {};
        filteredData.forEach(item => {
            if (!proveedorData[item.razonSocial]) {
                proveedorData[item.razonSocial] = {
                    total: 0,
                    documentos: 0,
                    rut: item.rutProveedor
                };
            }
            
            // Para notas de crédito, restar el monto
            const factor = item.esNotaCredito ? -1 : 1;
            proveedorData[item.razonSocial].total += item.montoNeto * factor;
            proveedorData[item.razonSocial].documentos += factor;
        });
        
        // Ordenar y obtener top 3
        const topProveedores = Object.keys(proveedorData)
            .sort((a, b) => proveedorData[b].total - proveedorData[a].total)
            .slice(0, 3);
        
        // Calcular el total para los porcentajes
        const totalCompras = topProveedores.reduce((sum, proveedor) => sum + proveedorData[proveedor].total, 0);
        
        // Crear tarjetas
        topProveedores.forEach((proveedor, index) => {
            const data = proveedorData[proveedor];
            const percentage = totalCompras > 0 ? (data.total / totalCompras * 100) : 0;
            
            const card = document.createElement('div');
            card.className = 'client-card';
            card.style.position = 'relative';
            
            const rank = document.createElement('div');
            rank.className = 'client-rank';
            rank.textContent = index + 1;
            
            // Truncar nombre para mostrar
            const truncatedName = truncateText(proveedor, 30);
            
            const name = document.createElement('div');
            name.className = 'client-name';
            name.title = proveedor; // Tooltip para nombres largos
            name.textContent = truncatedName;
            
            const info = document.createElement('div');
            info.className = 'client-info';
            info.textContent = `${data.documentos} documento${data.documentos !== 1 ? 's' : ''}`;
            
            // Añadir RUT si está disponible
            if (data.rut && data.rut !== 'N/A') {
                const rutInfo = document.createElement('div');
                rutInfo.className = 'client-info';
                rutInfo.innerHTML = `<strong>RUT:</strong> ${data.rut}`;
                info.appendChild(rutInfo);
            }
            
            const amount = document.createElement('div');
            amount.className = 'client-amount';
            amount.textContent = formatCurrency(data.total);
            
            const progress = document.createElement('div');
            progress.className = 'client-progress';
            
            const progressBar = document.createElement('div');
            progressBar.className = 'client-progress-bar';
            progressBar.style.width = `${percentage}%`;
            
            progress.appendChild(progressBar);
            
            const percentText = document.createElement('div');
            percentText.className = 'client-info';
            percentText.textContent = `${formatPercent(percentage)} del total top 3`;
            
            card.appendChild(rank);
            card.appendChild(name);
            card.appendChild(info);
            card.appendChild(amount);
            card.appendChild(percentText);
            card.appendChild(progress);
            
            proveedoresContainer.appendChild(card);
        });
        
        // Si no hay proveedores, mostrar mensaje
        if (topProveedores.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.innerHTML = `
                <div class="empty-icon"><i class="fas fa-building-circle-xmark"></i></div>
                <div class="empty-title">No hay datos de proveedores</div>
                <div class="empty-message">No se encontraron proveedores con los filtros actuales.</div>
            `;
            emptyState.style.gridColumn = '1 / -1';
            proveedoresContainer.appendChild(emptyState);
        }
    }

    // Actualizar métricas clave
    function updateKeyMetrics() {
        const metricsContainer = document.getElementById('key-metrics-container-compras');
        metricsContainer.innerHTML = '';
        
        // 1. Calcular IVA promedio
        const totalIVA = filteredData.reduce((sum, item) => {
            const factor = item.esNotaCredito ? -1 : 1;
            return sum + (item.montoIVA * factor);
        }, 0);
        
        const totalMontoNeto = filteredData.reduce((sum, item) => {
            const factor = item.esNotaCredito ? -1 : 1;
            return sum + (item.montoNeto * factor);
        }, 0);
        
        const pctIVA = totalMontoNeto > 0 ? (totalIVA / totalMontoNeto * 100) : 0;
        
        const metricaDistribucionIVA = document.createElement('div');
        metricaDistribucionIVA.className = 'analysis-metric';
        metricaDistribucionIVA.innerHTML = `
            <div class="metric-title">Porcentaje IVA</div>
            <div class="metric-value">${formatPercent(pctIVA)}</div>
            <div class="metric-info">
                IVA Total: ${formatCurrency(totalIVA)} | 
                Monto Neto: ${formatCurrency(totalMontoNeto)}
            </div>
        `;
        metricsContainer.appendChild(metricaDistribucionIVA);
        
        // 2. Promedio por Documento
        const totalDocs = filteredData.filter(item => !item.esNotaCredito).length;
        const promedioDoc = totalDocs > 0 ? totalMontoNeto / totalDocs : 0;
        
        const metricaPromedioDoc = document.createElement('div');
        metricaPromedioDoc.className = 'analysis-metric';
        metricaPromedioDoc.innerHTML = `
            <div class="metric-title">Promedio por Documento</div>
            <div class="metric-value">${formatCurrency(promedioDoc)}</div>
            <div class="metric-info">basado en ${totalDocs} documento${totalDocs !== 1 ? 's' : ''} de compra</div>
        `;
        metricsContainer.appendChild(metricaPromedioDoc);
        
        // 3. Porcentaje de Notas de Crédito
        const countNC = filteredData.filter(item => item.esNotaCredito).length;
        const totalCount = filteredData.length;
        const pctNC = totalCount > 0 ? (countNC / totalCount) * 100 : 0;
        
        const totalMontoNC = filteredData.filter(item => item.esNotaCredito)
            .reduce((sum, item) => sum + item.montoTotal, 0);
        const totalMontoFacturas = filteredData.filter(item => !item.esNotaCredito)
            .reduce((sum, item) => sum + item.montoTotal, 0);
        const pctMontoNC = totalMontoFacturas > 0 ? (totalMontoNC / totalMontoFacturas) * 100 : 0;
        
        const metricaNC = document.createElement('div');
        metricaNC.className = 'analysis-metric';
        metricaNC.innerHTML = `
            <div class="metric-title">Notas de Crédito vs. Compras</div>
            <div class="metric-value">${formatPercent(pctNC)}</div>
            <div class="metric-info">
                ${countNC} NC de un total de ${totalCount} documentos<br>
                Representan el ${formatPercent(pctMontoNC)} del monto total facturado
            </div>
        `;
        metricsContainer.appendChild(metricaNC);
        
        // 4. Métricas de documentos
        const maxFolio = filteredData.length > 0 ? 
            Math.max(...filteredData.map(item => parseInt(item.folio) || 0)) : 0;
        
        const minFolio = filteredData.length > 0 ? 
            Math.min(...filteredData.filter(item => parseInt(item.folio) > 0).map(item => parseInt(item.folio) || 0)) : 0;
        
        const metricaDocumentos = document.createElement('div');
        metricaDocumentos.className = 'analysis-metric';
        metricaDocumentos.innerHTML = `
            <div class="metric-title">Métricas de Documentos</div>
            <div class="metric-value">${totalCount} documentos</div>
            <div class="metric-info">
                Folio mínimo: ${minFolio}<br>
                Folio máximo: ${maxFolio}
            </div>
        `;
        metricsContainer.appendChild(metricaDocumentos);
    }

    // Actualizar tabla de compras
    function updateTable() {
        comprasTableBody.innerHTML = '';
        
        // Calcular total de páginas
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        
        // Ajustar página actual si es necesario
        if (currentPage > totalPages) {
            currentPage = totalPages > 0 ? totalPages : 1;
        }
        
        // Calcular índices para paginación
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
        
        // Obtener datos para la página actual
        const pageData = filteredData.slice(startIndex, endIndex);
        
        // Generar filas de la tabla
        pageData.forEach(item => {
            const row = document.createElement('tr');
            
            // Formatear fecha
            const fechaFormateada = item.fechaDocto.toLocaleDateString('es-CL');
            
            // Determinar si es una nota de crédito para formateo visual
            const isNC = item.esNotaCredito;
            
            // Truncar nombre del proveedor para mostrar
            const proveedorTruncado = truncateText(item.razonSocial, 30);
            
            row.innerHTML = `
                <td>${item.folio}</td>
                <td>${fechaFormateada}</td>
                <td>${item.tipoDocName}</td>
                <td title="${item.razonSocial}"><span class="truncate-text">${proveedorTruncado}</span></td>
                <td>${formatCurrency(item.montoNeto)}</td>
                <td>${formatCurrency(item.montoExento)}</td>
                <td>${formatCurrency(item.montoIVA)}</td>
                <td>${formatCurrency(item.montoTotal)}</td>
            `;
            
            // Agregar clase visual según tipo de documento
            if (isNC) {
                row.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
            }
            
            comprasTableBody.appendChild(row);
        });
        
        // Generar paginación
        updatePagination(totalPages);
        
        // Mostrar mensaje si no hay datos
        if (pageData.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="8">
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-file-invoice"></i></div>
                        <div class="empty-title">No se encontraron documentos</div>
                        <div class="empty-message">No hay compras o notas de crédito que coincidan con los filtros actuales.</div>
                    </div>
                </td>
            `;
            comprasTableBody.appendChild(emptyRow);
        }
    }

    // Actualizar controles de paginación
    function updatePagination(totalPages) {
        pagination.innerHTML = '';
        
        if (totalPages <= 1) {
            return;
        }
        
        // Texto informativo
        const infoText = document.createElement('span');
        infoText.style.marginRight = 'auto';
        infoText.style.fontSize = '14px';
        infoText.style.color = 'var(--text-secondary)';
        
        const startItem = (currentPage - 1) * rowsPerPage + 1;
        const endItem = Math.min(startItem + rowsPerPage - 1, filteredData.length);
        infoText.textContent = `Mostrando ${startItem}-${endItem} de ${filteredData.length} documentos`;
        
        pagination.appendChild(infoText);
        
        // Botón anterior
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerHTML = '&laquo;';
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        });
        pagination.appendChild(prevBtn);
        
        // Botones de página
        // Mostrar páginas: primera, actual -1, actual, actual +1, última
        const pageNumbers = new Set();
        pageNumbers.add(1); // Primera página
        pageNumbers.add(totalPages); // Última página
        
        if (currentPage > 1) pageNumbers.add(currentPage - 1);
        pageNumbers.add(currentPage);
        if (currentPage < totalPages) pageNumbers.add(currentPage + 1);
        
        const sortedPages = [...pageNumbers].sort((a, b) => a - b);
        
        let prevPage = 0;
        sortedPages.forEach(page => {
            // Agregar elipsis si hay saltos
            if (page - prevPage > 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'page-btn';
                ellipsis.style.cursor = 'default';
                pagination.appendChild(ellipsis);
            }
            
            // Botón de página
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${page === currentPage ? 'active-page' : ''}`;
            pageBtn.textContent = page;
            pageBtn.addEventListener('click', () => {
                currentPage = page;
                updateTable();
            });
            pagination.appendChild(pageBtn);
            
            prevPage = page;
        });
        
        // Botón siguiente
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerHTML = '&raquo;';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        });
        pagination.appendChild(nextBtn);
    }

    // Cargar datos automáticamente al inicializar
    fetchData();
}
</script>


<script>
// Función de inicialización para el Dashboard Comparativo
function initializeComparativoDashboard() {
    // Insertar el contenido HTML en el contenedor
    document.getElementById('comparativo-dashboard').innerHTML = `
        <div class="dashboard-container">
            <!-- Contenido Principal -->
            <div class="main-content">
                <!-- Encabezado de Sección con Filtros Múltiples -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-file-invoice-dollar"></i> Reporte de Ventas y Compras
                    </h2>
                    <div class="filter-container">
                        <div class="filter-item">
                            <span class="filter-label">Año</span>
                            <select id="year-filter-comparativo" class="filter-select" multiple="multiple">
                                <!-- Se llenará dinámicamente -->
                            </select>
                        </div>
                        <div class="filter-item">
                            <span class="filter-label">Mes</span>
                            <select id="month-filter-comparativo" class="filter-select" multiple="multiple">
                                <option value="01">Enero</option>
                                <option value="02">Febrero</option>
                                <option value="03">Marzo</option>
                                <option value="04">Abril</option>
                                <option value="05">Mayo</option>
                                <option value="06">Junio</option>
                                <option value="07">Julio</option>
                                <option value="08">Agosto</option>
                                <option value="09">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <button id="apply-filter-comparativo" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Aplicar
                            </button>
                        </div>
                        <div class="filter-item">
                            <button id="reset-filter-comparativo" class="btn btn-outline">
                                <i class="fas fa-undo"></i> Reiniciar
                            </button>
                        </div>
                        <div class="filter-item">
                            <button id="refresh-btn-comparativo" class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> Actualizar Datos
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Mensaje de carga -->
                <div id="loading-message-comparativo" class="loader-container hidden">
                    <div class="loader"></div>
                </div>
                <div id="error-message-comparativo" class="error-message"></div>

                <!-- Tarjetas de Resumen -->
                <div class="card-container">
                    <!-- Tarjeta de Ventas -->
                    <div class="stat-card">
                        <div class="stat-title">Total Ventas (Año actual)</div>
                        <div id="total-ventas-comparativo" class="stat-value">$0</div>
                        <div id="total-ventas-subtitle" class="stat-subtitle">
                            <i class="fas fa-calendar-alt"></i>
                            <span id="year-display-comparativo">2025</span>
                        </div>
                        <i class="fas fa-arrow-up stat-icon" style="color: var(--success);"></i>
                    </div>
                    
                    <!-- Tarjeta de Compras -->
                    <div class="stat-card">
                        <div class="stat-title">Total Compras (Año actual)</div>
                        <div id="total-compras-comparativo" class="stat-value">$0</div>
                        <div id="total-compras-subtitle" class="stat-subtitle">
                            <i class="fas fa-calendar-alt"></i>
                            <span>2025</span>
                        </div>
                        <i class="fas fa-arrow-down stat-icon" style="color: var(--warning);"></i>
                    </div>
                    
                    <!-- Tarjeta de Diferencia -->
                    <div class="stat-card">
                        <div class="stat-title">Diferencia Total</div>
                        <div id="total-diferencia-comparativo" class="stat-value">$0</div>
                        <div id="dif-trend-comparativo" class="stat-trend trend-up">
                            <i class="fas fa-arrow-up trend-icon"></i> Positivo
                        </div>
                        <i class="fas fa-balance-scale stat-icon" style="color: var(--secondary);"></i>
                    </div>
                </div>
                
                <!-- Gráfico Principal -->
                <div class="chart-card" style="margin-top: 20px;">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i> Evolución Mensual
                        </div>
                        <div id="last-update-time-comparativo" style="color: var(--gray); font-size: 14px;">
                            <i class="far fa-clock"></i> Última actualización: --:--
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="main-chart-comparativo"></canvas>
                    </div>
                </div>
                
                <!-- Tabs de navegación -->
                <div class="tabs-container" style="margin-top: 30px;">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="monthly-comparativo">Por Mes</button>
                        <button class="tab-btn" data-tab="accumulated-comparativo">Acumulado Anual</button>
                    </div>
                </div>
                
                <!-- Tab content: Por Mes -->
                <div id="tab-monthly-comparativo" class="tab-content active">
                    
                    <!-- Análisis Detallado de Margen -->
                    <div class="section" style="margin-top: 20px;">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-chart-line"></i> Análisis Detallado de Margen
                            </h2>
                        </div>
                        
                        <!-- Tarjetas de Análisis de Margen -->
                        <div class="analysis-grid" style="margin-top: 20px;">
                            <!-- Margen Actual -->
                            <div class="analysis-metric">
                                <div class="metric-title">Margen Actual</div>
                                <div id="current-margin-comparativo" class="metric-value">$0</div>
                                <div id="current-margin-percent-comparativo" class="metric-info">0% del total de ventas</div>
                            </div>
                            
                            <!-- Variación vs Mes Anterior -->
                            <div class="analysis-metric">
                                <div class="metric-title">Variación vs Mes Anterior</div>
                                <div id="monthly-variation-comparativo" class="metric-value">$0</div>
                                <div id="monthly-variation-percent-comparativo" class="metric-info">0%</div>
                                <div id="monthly-trend-comparativo" class="metric-info">
                                    <i class="fas fa-minus"></i> Sin cambios
                                </div>
                            </div>
                            
                            <!-- Variación vs Año Anterior -->
                            <div class="analysis-metric">
                                <div class="metric-title">Variación Anual</div>
                                <div id="yearly-variation-comparativo" class="metric-value">$0</div>
                                <div id="yearly-variation-percent-comparativo" class="metric-info">0%</div>
                                <div id="yearly-trend-comparativo" class="metric-info">
                                    <i class="fas fa-minus"></i> Sin cambios
                                </div>
                            </div>
                            
                            <!-- Tendencia del Margen -->
                            <div class="analysis-metric">
                                <div class="metric-title">Tendencia del Margen</div>
                                <div class="chart-container" style="height: 120px;">
                                    <canvas id="margin-trend-chart-comparativo"></canvas>
                                </div>
                                <div id="trend-summary-comparativo" class="metric-info">Pendiente de datos</div>
                            </div>
                        </div>
                        
                        <!-- Gráfico de Margen Porcentual -->
                        <div class="chart-card" style="margin-top: 20px;">
                            <div class="chart-header">
                                <h3 class="chart-title"><i class="fas fa-percentage"></i> Evolución del Margen Porcentual</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="margin-percent-chart-comparativo"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabla de Datos -->
                    <div class="table-section" style="margin-top: 30px;">
                        <div class="table-header">
                            <div class="table-title">
                                <i class="fas fa-table"></i> Detalle Mensual
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Período</th>
                                        <th>Ventas</th>
                                        <th>Compras</th>
                                        <th>Diferencia</th>
                                        <th>Margen %</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body-comparativo">
                                    <!-- Aquí se insertan los datos dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tab content: Acumulado Anual -->
                <div id="tab-accumulated-comparativo" class="tab-content">
                    <!-- Análisis de Acumulado Anual -->
                    <div class="section" style="margin-top: 20px;">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-chart-line"></i> Análisis de Acumulado Anual
                            </h2>
                        </div>
                        
                        <!-- Gráfico de Acumulado Anual -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="fas fa-chart-area"></i> Evolución Acumulada
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="accumulated-chart-comparativo"></canvas>
                            </div>
                        </div>
                        
                        <!-- Métricas de Acumulado -->
                        <div class="analysis-grid" style="margin-top: 20px;">
                            <!-- Ventas Acumuladas -->
                            <div class="analysis-metric">
                                <div class="metric-title">Ventas Acumuladas</div>
                                <div id="accumulated-sales-comparativo" class="metric-value">$0</div>
                                <div id="accumulated-sales-period-comparativo" class="metric-info">Año actual</div>
                            </div>
                            
                            <!-- Compras Acumuladas -->
                            <div class="analysis-metric">
                                <div class="metric-title">Compras Acumuladas</div>
                                <div id="accumulated-purchases-comparativo" class="metric-value">$0</div>
                                <div id="accumulated-purchases-period-comparativo" class="metric-info">Año actual</div>
                            </div>
                            
                            <!-- Margen Acumulado -->
                            <div class="analysis-metric">
                                <div class="metric-title">Margen Acumulado</div>
                                <div id="accumulated-margin-comparativo" class="metric-value">$0</div>
                                <div id="accumulated-margin-percent-comparativo" class="metric-info">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabla de Acumulado Anual -->
                    <div class="table-section" style="margin-top: 30px;">
                        <div class="table-header">
                            <div class="table-title">
                                <i class="fas fa-table"></i> Acumulado por Mes
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Período</th>
                                        <th>Ventas Acumuladas</th>
                                        <th>Compras Acumuladas</th>
                                        <th>Margen Acumulado</th>
                                        <th>Margen %</th>
                                    </tr>
                                </thead>
                                <tbody id="accumulated-table-body-comparativo">
                                    <!-- Aquí se insertan los datos dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Sección de Información -->
                <div class="section" style="margin-top: 30px; padding: 20px; background-color: white; border-radius: 10px; box-shadow: var(--shadow); border-left: 4px solid var(--primary);">
                    <div style="font-size: 20px; font-weight: 600; margin-bottom: 15px; color: var(--primary-dark); display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-right: 10px;"></i> Acerca de este Reporte
                    </div>
                    <div style="font-size: 15px; line-height: 1.7; color: var(--text-secondary);">
                        <p>Este dashboard muestra la información consolidada de ventas y compras basada en los libros electrónicos de contabilidad. Los datos son extraídos directamente desde el sistema y comparados para analizar:</p>
                        
                        <ul style="padding-left: 20px; margin-bottom: 15px;">
                            <li><strong>Facturas de Venta:</strong> Documentos tipo 33 y sus notas de crédito asociadas (tipo 61)</li>
                            <li><strong>Facturas de Compra:</strong> Incluye montos netos, exentos e IVA recuperable/no recuperable</li>
                        </ul>
                        
                        <p>Para el cálculo se utilizan las siguientes fórmulas:</p>
                        
                        <ul style="padding-left: 20px; margin-bottom: 15px;">
                            <li><strong>Ventas Totales:</strong> Venta Neta + Exento - Notas de Crédito</li>
                            <li><strong>Compras Totales:</strong> Compra Neta + Exento - Notas de Crédito</li>
                            <li><strong>Diferencia:</strong> Ventas Totales - Compras Totales</li>
                            <li><strong>Margen Porcentual:</strong> (Diferencia / Ventas Totales) × 100</li>
                            <li><strong>Acumulado Anual:</strong> Suma progresiva de los valores mensuales para el año seleccionado</li>
                        </ul>
                        
                        <p>Los datos se actualizan en tiempo real al hacer clic en el botón "Actualizar Datos" y provienen directamente de las APIs de Ventas y Compras. Puede utilizar los filtros de año y mes para analizar períodos específicos.</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    // URLs para obtener datos de ventas y compras
    const ventasUrl = 'https://prod-77.westus.logic.azure.com:443/workflows/1ba29feb037d422bb281c8c8eacc4a04/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9gjMKfE5XIxBTi-KNXchpZN6eGq8xDgrM5g';
    const comprasUrl = 'https://prod-133.westus.logic.azure.com:443/workflows/9ecb5bdf91a342ee9f722657534c4afa/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=d5r1enWX0S8V98f8Y5SbkZUX6xmB5-NwhxqV6Xxd7rc';

    // Variables para datos
    let ventasData = [];
    let comprasData = [];
    let reportData = [];
    let filteredData = [];

    // Variables para gráficos
    let mainChart = null;
    let marginTrendChart = null;
    let marginPercentChart = null;
    let accumulatedChart = null;

    // Referencias a elementos DOM
    const yearFilter = document.getElementById('year-filter-comparativo');
    const monthFilter = document.getElementById('month-filter-comparativo');
    const applyFilterBtn = document.getElementById('apply-filter-comparativo');
    const resetFilterBtn = document.getElementById('reset-filter-comparativo');
    const refreshBtn = document.getElementById('refresh-btn-comparativo');
    const loadingMessage = document.getElementById('loading-message-comparativo');
    const errorMessage = document.getElementById('error-message-comparativo');
    const lastUpdateTime = document.getElementById('last-update-time-comparativo');

    // Inicializar Select2 para filtros múltiples
    function initializeSelect2() {
        $(yearFilter).select2({
            placeholder: 'Seleccionar años',
            allowClear: true,
            closeOnSelect: false
        });
        
        $(monthFilter).select2({
            placeholder: 'Seleccionar meses',
            allowClear: true,
            closeOnSelect: false
        });
    }

    // Inicializar Select2
    initializeSelect2();

    // Eventos para filtros
    applyFilterBtn.addEventListener('click', applyFilters);
    resetFilterBtn.addEventListener('click', resetFilters);
    refreshBtn.addEventListener('click', fetchData);

    // Inicializar sistema de pestañas
    document.querySelectorAll('#comparativo-dashboard .tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            
            // Cambiar pestañas activas
            document.querySelectorAll('#comparativo-dashboard .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#comparativo-dashboard .tab-content').forEach(content => content.classList.remove('active'));
            
            button.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        });
    });

    // Formateo de moneda
    function formatCurrency(value) {
        return new Intl.NumberFormat('es-CL', { 
            style: 'currency', 
            currency: 'CLP',
            maximumFractionDigits: 0
        }).format(value);
    }

    // Formateo de moneda compacta
    function formatCurrencyCompact(value) {
        return new Intl.NumberFormat('es-CL', { 
            style: 'currency', 
            currency: 'CLP',
            notation: 'compact',
            compactDisplay: 'short',
            maximumFractionDigits: 0
        }).format(value);
    }

    // Formateo de porcentaje
    function formatPercent(value) {
        return `${value.toFixed(1)}%`;
    }

    // Función para actualizar timestamp
    function updateLastUpdateTime() {
        const now = new Date();
        const options = { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        };
        const formattedDate = now.toLocaleDateString('es-CL', options);
        lastUpdateTime.innerHTML = `<i class="far fa-clock"></i> Última actualización: ${formattedDate}`;
    }

    // Función para llenar selectores de años
    function populateYearFilter() {
        // Limpiar opciones actuales
        $(yearFilter).empty();
        
        if (reportData.length > 0) {
            // Obtener años únicos
            const years = [...new Set(reportData.map(item => item.anio))];
            years.sort((a, b) => b - a); // Ordenar descendente
            
            // Añadir opciones
            years.forEach(year => {
                const option = new Option(year, year, false, false);
                $(yearFilter).append(option);
            });
            
            // Refrescar Select2
            $(yearFilter).trigger('change');
        }
    }

    // Función para obtener años y meses seleccionados
    function getSelectedFilters() {
        return {
            years: $(yearFilter).val() || [],
            months: $(monthFilter).val() || []
        };
    }

    // Función para aplicar filtros
    function applyFilters() {
        const { years, months } = getSelectedFilters();
        
        // Filtrar datos
        filteredData = [...reportData];
        
        // Filtrar por años
        if (years.length > 0) {
            const yearsInt = years.map(y => parseInt(y, 10));
            filteredData = filteredData.filter(item => yearsInt.includes(item.anio));
        }
        
        // Filtrar por meses
        if (months.length > 0) {
            const monthsInt = months.map(m => parseInt(m, 10));
            filteredData = filteredData.filter(item => monthsInt.includes(item.mes));
        }
        
        // Actualizar componentes con datos filtrados
        updateAllComponents();
        
        // Construir mensaje de filtros aplicados
        let filterMessage = 'Filtros aplicados';
        
        if (years.length > 0 || months.length > 0) {
            showToast(filterMessage, 'success');
        }
    }

    // Función para resetear filtros
    function resetFilters() {
        // Resetear filtros de Select2
        $(yearFilter).val(null).trigger('change');
        $(monthFilter).val(null).trigger('change');
        
        // Usar todos los datos
        filteredData = [...reportData];
        
        // Actualizar componentes
        updateAllComponents();
        
        showToast('Filtros reiniciados', 'success');
    }

    // Función para obtener y procesar datos
    async function fetchData() {
        // Mostrar carga y ocultar errores
        loadingMessage.classList.remove('hidden');
        errorMessage.textContent = '';
        refreshBtn.disabled = true;
        
        try {
            // Obtener datos de ventas
            const ventasResponse = await fetch(ventasUrl);
            if (!ventasResponse.ok) {
                throw new Error(`Error al obtener ventas: ${ventasResponse.status}`);
            }
            const ventasRawData = await ventasResponse.json();
            
            // Obtener datos de compras
            const comprasResponse = await fetch(comprasUrl);
            if (!comprasResponse.ok) {
                throw new Error(`Error al obtener compras: ${comprasResponse.status}`);
            }
            let comprasRawData = await comprasResponse.json();
            
            // Verificar formato de datos de compras (podría venir dentro de un objeto 'body')
            if (comprasRawData.body && Array.isArray(comprasRawData.body)) {
                comprasRawData = comprasRawData.body;
            }
            
            // Procesar datos de ventas
            ventasData = processVentasData(ventasRawData);
            
            // Procesar datos de compras
            comprasData = processComprasData(comprasRawData);
            
            // Generar datos de reporte combinados
            generateReportData();
            
            // Actualizar filtros
            populateYearFilter();
            
            // Inicialmente, mostrar todos los datos
            filteredData = [...reportData];
            
            // Actualizar componentes
            updateAllComponents();
            
            // Actualizar timestamp
            updateLastUpdateTime();
            
            showToast('Datos actualizados correctamente', 'success');
            
        } catch (error) {
            console.error('Error al cargar datos:', error);
            errorMessage.textContent = `Error: ${error.message}`;
            showToast('Error al cargar datos', 'error');
        } finally {
            loadingMessage.classList.add('hidden');
            refreshBtn.disabled = false;
        }
    }

    // Procesar datos de ventas
    function processVentasData(data) {
        if (!Array.isArray(data)) {
            console.error("Los datos de ventas no son un array:", data);
            return [];
        }
        
        return data.map(item => {
            // Procesar fecha
            let fechaObj;
            try {
                fechaObj = new Date(item['Fecha_x0020_Docto'] || '');
                if (isNaN(fechaObj.getTime())) {
                    fechaObj = new Date();
                }
            } catch (e) {
                fechaObj = new Date();
            }
            
            // Calcular montos relevantes
            const tipoDoc = parseInt(item['Tipo_x0020_Doc'] || 0);
            const esNotaCredito = tipoDoc === 61;
            
            const montoNetoSinIVA = parseFloat(item.MontoNetoSinIVA || (parseFloat(item['Monto_x0020_total'] || 0) / 1.19)) || 0;
            const exento = parseFloat(item.MontoExento || 0);
            
            // Para notas de crédito, considerar montos como negativos
            const factor = esNotaCredito ? -1 : 1;
            const montoNeto = (montoNetoSinIVA + exento) * factor;
            
            return {
                fecha: fechaObj,
                anio: fechaObj.getFullYear(),
                mes: parseInt(fechaObj.getMonth() + 1),
                mesStr: String(fechaObj.getMonth() + 1).padStart(2, '0'),
                periodo: `${fechaObj.getFullYear()}-${String(fechaObj.getMonth() + 1).padStart(2, '0')}`,
                montoNeto: montoNeto,
                esNotaCredito: esNotaCredito
            };
        });
    }

    // Procesar datos de compras
    function processComprasData(data) {
        if (!Array.isArray(data)) {
            console.error("Los datos de compras no son un array:", data);
            return [];
        }
        
        return data.map(item => {
            // Procesar fecha
            let fechaObj;
            try {
                const fechaStr = item['Fecha_x0020_Docto'] || '';
                fechaObj = new Date(fechaStr);
                if (isNaN(fechaObj.getTime())) {
                    fechaObj = new Date();
                }
            } catch (e) {
                fechaObj = new Date();
            }
            
            // Determinar si es nota de crédito
            const tipoDoc = parseInt(item['Tipo_x0020_Doc'] || 0);
            const esNotaCredito = tipoDoc === 61;
            
            // Calcular monto neto (incluye exento)
            const montoNeto = parseFloat(item['Monto_x0020_Neto'] || 0);
            const montoExento = parseFloat(item['Monto_x0020_Exento'] || 0);
            
            // Para notas de crédito, considerar montos como negativos
            const factor = esNotaCredito ? -1 : 1;
            const montoTotal = (montoNeto + montoExento) * factor;
            
            return {
                fecha: fechaObj,
                anio: fechaObj.getFullYear(),
                mes: parseInt(fechaObj.getMonth() + 1),
                mesStr: String(fechaObj.getMonth() + 1).padStart(2, '0'),
                periodo: `${fechaObj.getFullYear()}-${String(fechaObj.getMonth() + 1).padStart(2, '0')}`,
                montoNeto: montoTotal,
                esNotaCredito: esNotaCredito
            };
        });
    }

    // Generar datos de reporte combinados (ventas vs compras)
    function generateReportData() {
        // Obtener todos los periodos únicos
        const periodos = new Set();
        
        ventasData.forEach(item => periodos.add(item.periodo));
        comprasData.forEach(item => periodos.add(item.periodo));
        
        // Convertir a array y ordenar
        const periodosArray = [...periodos].sort();
        
        // Generar datos de reporte por período
        reportData = periodosArray.map(periodo => {
            // Extraer año y mes del período
            const [anio, mes] = periodo.split('-').map(num => parseInt(num, 10));
            
            // Filtrar datos de ventas y compras para este período
            const ventasPeriodo = ventasData.filter(item => item.periodo === periodo);
            const comprasPeriodo = comprasData.filter(item => item.periodo === periodo);
            
            // Calcular totales
            const ventas = ventasPeriodo.reduce((sum, item) => sum + item.montoNeto, 0);
            const compras = comprasPeriodo.reduce((sum, item) => sum + item.montoNeto, 0);
            
            // Calcular diferencia
            const diferencia = ventas - compras;
            
            // Calcular margen porcentual
            const margenPct = ventas > 0 ? (diferencia / ventas) * 100 : 0;
            
            return {
                periodo: periodo,
                anio: anio,
                mes: mes,
                mesStr: String(mes).padStart(2, '0'),
                ventas: ventas,
                compras: compras,
                diferencia: diferencia,
                margenPct: margenPct
            };
        });
    }

    // Actualizar tarjetas de resumen
    function updateSummaryCards() {
        if (filteredData.length === 0) {
            document.getElementById('total-ventas-comparativo').textContent = formatCurrency(0);
            document.getElementById('total-compras-comparativo').textContent = formatCurrency(0);
            document.getElementById('total-diferencia-comparativo').textContent = formatCurrency(0);
            document.getElementById('dif-trend-comparativo').innerHTML = '<i class="fas fa-minus"></i> Sin datos';
            document.getElementById('dif-trend-comparativo').className = 'stat-trend trend-neutral';
            return;
        }
        
        // Calcular totales
        const totalVentas = filteredData.reduce((sum, item) => sum + item.ventas, 0);
        const totalCompras = filteredData.reduce((sum, item) => sum + item.compras, 0);
        const totalDiferencia = totalVentas - totalCompras;
        
        // Mostrar año en la tarjeta según el filtro
        const years = getSelectedFilters().years;
        if (years.length === 1) {
            document.getElementById('year-display-comparativo').textContent = years[0];
        } else {
            const currentYear = new Date().getFullYear();
            document.getElementById('year-display-comparativo').textContent = currentYear;
        }
        
        // Actualizar elementos HTML
        document.getElementById('total-ventas-comparativo').textContent = formatCurrency(totalVentas);
        document.getElementById('total-compras-comparativo').textContent = formatCurrency(totalCompras);
        document.getElementById('total-diferencia-comparativo').textContent = formatCurrency(totalDiferencia);
        
        // Calcular margen porcentual
        const marginPercent = totalVentas > 0 ? (totalDiferencia / totalVentas) * 100 : 0;
        
        // Actualizar tendencia
        const difTrend = document.getElementById('dif-trend-comparativo');
        if (totalDiferencia > 0) {
            difTrend.innerHTML = `<i class="fas fa-arrow-up trend-icon"></i> Positivo (${marginPercent.toFixed(1)}%)`;
            difTrend.className = 'stat-trend trend-up';
        } else if (totalDiferencia < 0) {
            difTrend.innerHTML = `<i class="fas fa-arrow-down trend-icon"></i> Negativo (${marginPercent.toFixed(1)}%)`;
            difTrend.className = 'stat-trend trend-down';
        } else {
            difTrend.innerHTML = '<i class="fas fa-minus trend-icon"></i> Neutro (0%)';
            difTrend.className = 'stat-trend trend-neutral';
        }
    }

    // Actualizar gráfico principal
    function updateMainChart() {
        const ctx = document.getElementById('main-chart-comparativo').getContext('2d');
        
        if (filteredData.length === 0) {
            if (mainChart) {
                mainChart.destroy();
                mainChart = null;
            }
            return;
        }
        
        // Ordenar datos cronológicamente
        const chartData = [...filteredData].sort((a, b) => {
            if (a.anio !== b.anio) return a.anio - b.anio;
            return a.mes - b.mes;
        });
        
        // Limitar a los últimos 12 meses para mejor visualización si hay muchos datos
        let limitedData = chartData;
        if (chartData.length > 12 && getSelectedFilters().years.length === 0 && getSelectedFilters().months.length === 0) {
            limitedData = chartData.slice(-12);
        }
        
        // Nombres de meses en español
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        // Preparar datos para el gráfico
        const labels = limitedData.map(item => {
            const monthName = monthNames[item.mes - 1];
            return `${monthName} ${item.anio}`;
        });
        const ventasData = limitedData.map(item => item.ventas);
        const comprasData = limitedData.map(item => item.compras);
        const diferenciaData = limitedData.map(item => item.diferencia);
        
        // Configuración del gráfico
        const chartConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ventas',
                        data: ventasData,
                        backgroundColor: 'rgba(76, 201, 240, 0.6)',
                        borderColor: 'rgb(76, 201, 240)',
                        borderWidth: 1,
                        borderRadius: 4,
                        order: 2
                    },
                    {
                        label: 'Compras',
                        data: comprasData,
                        backgroundColor: 'rgba(247, 37, 133, 0.6)',
                        borderColor: 'rgb(247, 37, 133)',
                        borderWidth: 1,
                        borderRadius: 4,
                        order: 3
                    },
                    {
                        label: 'Diferencia',
                        type: 'line',
                        data: diferenciaData,
                        backgroundColor: 'rgba(58, 12, 163, 0.1)',
                        borderColor: 'rgb(58, 12, 163)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(58, 12, 163)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrencyCompact(value);
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 10,
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        };
        
        // Si ya existe un gráfico, destruirlo
        if (mainChart) {
            mainChart.destroy();
        }
        
        // Crear nuevo gráfico
        mainChart = new Chart(ctx, chartConfig);
    }

    // Actualizar análisis de margen
    function updateMarginAnalysis() {
        if (filteredData.length === 0) {
            document.getElementById('current-margin-comparativo').textContent = formatCurrency(0);
            document.getElementById('current-margin-percent-comparativo').textContent = '0% del total de ventas';
            document.getElementById('monthly-variation-comparativo').textContent = formatCurrency(0);
            document.getElementById('monthly-variation-percent-comparativo').textContent = '0%';
            document.getElementById('monthly-trend-comparativo').innerHTML = '<i class="fas fa-minus"></i> Sin datos previos';
            document.getElementById('yearly-variation-comparativo').textContent = formatCurrency(0);
            document.getElementById('yearly-variation-percent-comparativo').textContent = '0%';
            document.getElementById('yearly-trend-comparativo').innerHTML = '<i class="fas fa-minus"></i> Sin datos previos';
            document.getElementById('trend-summary-comparativo').textContent = 'Sin datos suficientes para análisis';
            
            if (marginTrendChart) {
                marginTrendChart.destroy();
                marginTrendChart = null;
            }
            
            if (marginPercentChart) {
                marginPercentChart.destroy();
                marginPercentChart = null;
            }
            
            return;
        }
        
        // Ordenar datos por fecha (más reciente primero)
        const sortedData = [...filteredData].sort((a, b) => {
            if (a.anio !== b.anio) return b.anio - a.anio;
            return b.mes - a.mes;
        });
        
        // Datos actuales (último período)
        const currentData = sortedData[0];
        
        // Datos del mes anterior (si existen)
        const previousMonthData = sortedData.find(item => {
            if (currentData.mes === 1) {
                return item.mes === 12 && item.anio === currentData.anio - 1;
            } else {
                return item.mes === currentData.mes - 1 && item.anio === currentData.anio;
            }
        });
        
        // Datos del mismo mes del año anterior
        const previousYearData = sortedData.find(item => 
            item.mes === currentData.mes && item.anio === currentData.anio - 1
        );
        
        // Actualizar tarjeta de margen actual
        const currentMargin = currentData.diferencia;
        const currentMarginPercent = currentData.margenPct;
        
        document.getElementById('current-margin-comparativo').textContent = formatCurrency(currentMargin);
        document.getElementById('current-margin-percent-comparativo').textContent = `${currentMarginPercent.toFixed(2)}% del total de ventas`;
        
        // Actualizar variación mes anterior
        if (previousMonthData) {
            const monthlyVariation = currentMargin - previousMonthData.diferencia;
            const monthlyVariationPercent = currentMarginPercent - previousMonthData.margenPct;
            
            document.getElementById('monthly-variation-comparativo').textContent = formatCurrency(monthlyVariation);
            document.getElementById('monthly-variation-percent-comparativo').textContent = `${monthlyVariationPercent.toFixed(2)}%`;
            
            // Actualizar tendencia mensual
            const trendElement = document.getElementById('monthly-trend-comparativo');
            if (monthlyVariation > 0) {
                trendElement.innerHTML = '<i class="fas fa-arrow-up"></i> Incremento';
                trendElement.style.color = 'var(--success)';
            } else if (monthlyVariation < 0) {
                trendElement.innerHTML = '<i class="fas fa-arrow-down"></i> Reducción';
                trendElement.style.color = 'var(--danger)';
            } else {
                trendElement.innerHTML = '<i class="fas fa-minus"></i> Sin cambios';
                trendElement.style.color = 'var(--text-secondary)';
            }
        } else {
            document.getElementById('monthly-variation-comparativo').textContent = 'N/A';
            document.getElementById('monthly-variation-percent-comparativo').textContent = 'N/A';
            document.getElementById('monthly-trend-comparativo').innerHTML = '<i class="fas fa-minus"></i> Sin datos previos';
            document.getElementById('monthly-trend-comparativo').style.color = 'var(--text-secondary)';
        }
        
        // Actualizar variación anual
        if (previousYearData) {
            const yearlyVariation = currentMargin - previousYearData.diferencia;
            const yearlyVariationPercent = currentMarginPercent - previousYearData.margenPct;
            
            document.getElementById('yearly-variation-comparativo').textContent = formatCurrency(yearlyVariation);
            document.getElementById('yearly-variation-percent-comparativo').textContent = `${yearlyVariationPercent.toFixed(2)}%`;
            
            // Actualizar tendencia anual
            const trendElement = document.getElementById('yearly-trend-comparativo');
            if (yearlyVariation > 0) {
                trendElement.innerHTML = '<i class="fas fa-arrow-up"></i> Incremento';
                trendElement.style.color = 'var(--success)';
            } else if (yearlyVariation < 0) {
                trendElement.innerHTML = '<i class="fas fa-arrow-down"></i> Reducción';
                trendElement.style.color = 'var(--danger)';
            } else {
                trendElement.innerHTML = '<i class="fas fa-minus"></i> Sin cambios';
                trendElement.style.color = 'var(--text-secondary)';
            }
        } else {
            document.getElementById('yearly-variation-comparativo').textContent = 'N/A';
            document.getElementById('yearly-variation-percent-comparativo').textContent = 'N/A';
            document.getElementById('yearly-trend-comparativo').innerHTML = '<i class="fas fa-minus"></i> Sin datos previos';
            document.getElementById('yearly-trend-comparativo').style.color = 'var(--text-secondary)';
        }
        
        // Actualizar gráfico de tendencia y margen porcentual
        updateMarginTrendChart();
        updateMarginPercentChart();
    }

    // Actualizar gráfico de tendencia del margen
    function updateMarginTrendChart() {
        const ctx = document.getElementById('margin-trend-chart-comparativo').getContext('2d');
        
        if (filteredData.length < 3) {
            document.getElementById('trend-summary-comparativo').textContent = 'Se necesitan al menos 3 períodos para el análisis de tendencia';
            if (marginTrendChart) {
                marginTrendChart.destroy();
                marginTrendChart = null;
            }
            return;
        }
        
        // Ordenar datos para el gráfico (del más antiguo al más reciente)
        const chartData = [...filteredData]
            .sort((a, b) => {
                if (a.anio !== b.anio) return a.anio - b.anio;
                return a.mes - b.mes;
            })
            .slice(-6); // Mostrar los últimos 6 períodos
        
        // Nombres de meses en español
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        // Preparar datos para el gráfico
        const labels = chartData.map(item => {
            const monthName = monthNames[item.mes - 1];
            return `${monthName.substr(0, 3)}`;
        });
        const marginData = chartData.map(item => item.diferencia);
        
        // Calcular tendencia general
        let trendDescription = 'Sin suficientes datos para análisis de tendencia';
        const firstValue = marginData[0];
        const lastValue = marginData[marginData.length - 1];
        
        // Evitar división por cero
        const changePercent = Math.abs(firstValue) > 0 ? ((lastValue - firstValue) / Math.abs(firstValue)) * 100 : 0;
        
        if (changePercent > 5) {
            trendDescription = `Tendencia positiva (+${changePercent.toFixed(1)}%) en los últimos ${chartData.length} períodos`;
            document.getElementById('trend-summary-comparativo').style.color = 'var(--success)';
        } else if (changePercent < -5) {
            trendDescription = `Tendencia negativa (${changePercent.toFixed(1)}%) en los últimos ${chartData.length} períodos`;
            document.getElementById('trend-summary-comparativo').style.color = 'var(--danger)';
        } else {
            trendDescription = `Tendencia estable (${changePercent.toFixed(1)}%) en los últimos ${chartData.length} períodos`;
            document.getElementById('trend-summary-comparativo').style.color = 'var(--text-secondary)';
        }
        
        document.getElementById('trend-summary-comparativo').textContent = trendDescription;
        
        // Configuración del gráfico
        const chartConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Margen',
                    data: marginData,
                    backgroundColor: 'rgba(58, 12, 163, 0.1)',
                    borderColor: 'rgb(58, 12, 163)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(33, 37, 41, 0.8)',
                        callbacks: {
                            label: function(context) {
                                return formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        display: true,
                        ticks: {
                            display: false
                        },
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        display: true,
                        grid: {
                            display: false
                        }
                    }
                }
            }
        };
        
        // Si ya existe un gráfico, destruirlo
        if (marginTrendChart) {
            marginTrendChart.destroy();
        }
        
        // Crear nuevo gráfico
        marginTrendChart = new Chart(ctx, chartConfig);
    }

    // Actualizar gráfico de margen porcentual
    function updateMarginPercentChart() {
        const ctx = document.getElementById('margin-percent-chart-comparativo').getContext('2d');
        
        if (filteredData.length === 0) {
            if (marginPercentChart) {
                marginPercentChart.destroy();
                marginPercentChart = null;
            }
            return;
        }
        
        // Ordenar datos para el gráfico (del más antiguo al más reciente)
        const chartData = [...filteredData]
            .sort((a, b) => {
                if (a.anio !== b.anio) return a.anio - b.anio;
                return a.mes - b.mes;
            });
        
        // Nombres de meses en español
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        // Preparar datos para el gráfico
        const labels = chartData.map(item => {
            const monthName = monthNames[item.mes - 1];
            return `${monthName} ${item.anio}`;
        });
        const marginPercentData = chartData.map(item => item.margenPct);
        
        // Configuración del gráfico
        const chartConfig = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Margen %',
                    data: marginPercentData,
                    backgroundColor: marginPercentData.map(value => 
                        value >= 0 ? 'rgba(46, 204, 113, 0.6)' : 'rgba(231, 76, 60, 0.6)'
                    ),
                    borderColor: marginPercentData.map(value => 
                        value >= 0 ? 'rgb(46, 204, 113)' : 'rgb(231, 76, 60)'
                    ),
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y.toFixed(2)}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return `${value}%`;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        };
        
        // Si ya existe un gráfico, destruirlo
        if (marginPercentChart) {
            marginPercentChart.destroy();
        }
        
        // Crear nuevo gráfico
        marginPercentChart = new Chart(ctx, chartConfig);
    }

    // Actualizar tabla de datos mensuales
    function updateDataTable() {
        const tableBody = document.getElementById('table-body-comparativo');
        tableBody.innerHTML = '';
        
        if (filteredData.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="5" style="text-align: center; padding: 30px;">
                    <div style="color: var(--gray); font-size: 16px;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>No hay datos disponibles para los filtros seleccionados.</p>
                    </div>
                </td>
            `;
            tableBody.appendChild(emptyRow);
            return;
        }
        
        // Ordenar datos por fecha (más reciente primero)
        const sortedData = [...filteredData].sort((a, b) => {
            if (a.anio !== b.anio) return b.anio - a.anio;
            return b.mes - a.mes;
        });
        
        // Nombres de meses en español
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        // Generar filas de la tabla
        sortedData.forEach(item => {
            const row = document.createElement('tr');
            
            // Determinar clase para la diferencia y margen
            const diffClass = item.diferencia >= 0 ? 'value-positive' : 'value-negative';
            
            // Crear celdas
            row.innerHTML = `
                <td>${monthNames[item.mes - 1]} ${item.anio}</td>
                <td>${formatCurrency(item.ventas)}</td>
                <td>${formatCurrency(item.compras)}</td>
                <td class="${diffClass}">${formatCurrency(item.diferencia)}</td>
                <td class="${diffClass}">${item.margenPct.toFixed(1)}%</td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Actualizar gráfico y tabla de acumulado anual
    function updateAccumulatedData() {
        if (filteredData.length === 0) {
            document.getElementById('accumulated-sales-comparativo').textContent = formatCurrency(0);
            document.getElementById('accumulated-purchases-comparativo').textContent = formatCurrency(0);
            document.getElementById('accumulated-margin-comparativo').textContent = formatCurrency(0);
            document.getElementById('accumulated-margin-percent-comparativo').textContent = '0%';
            
            if (accumulatedChart) {
                accumulatedChart.destroy();
                accumulatedChart = null;
            }
            
            // Limpiar tabla
            document.getElementById('accumulated-table-body-comparativo').innerHTML = '';
            
            return;
        }
        
        // Agrupar datos por año
        const yearGroups = {};
        filteredData.forEach(item => {
            if (!yearGroups[item.anio]) {
                yearGroups[item.anio] = [];
            }
            yearGroups[item.anio].push(item);
        });
        
        // Si hay múltiples años, usar el más reciente para el gráfico
        const selectedYear = Object.keys(yearGroups).sort((a, b) => b - a)[0];
        const yearData = yearGroups[selectedYear].sort((a, b) => a.mes - b.mes);
        
        // Preparar datos acumulados
        const accumulatedData = [];
        let accumulatedSales = 0;
        let accumulatedPurchases = 0;
        
        yearData.forEach(item => {
            accumulatedSales += item.ventas;
            accumulatedPurchases += item.compras;
            const accumulatedMargin = accumulatedSales - accumulatedPurchases;
            const marginPercent = accumulatedSales > 0 ? (accumulatedMargin / accumulatedSales) * 100 : 0;
            
            accumulatedData.push({
                ...item,
                accumulatedSales: accumulatedSales,
                accumulatedPurchases: accumulatedPurchases,
                accumulatedMargin: accumulatedMargin,
                accumulatedMarginPercent: marginPercent
            });
        });
        
        // Actualizar gráfico de acumulado
        updateAccumulatedChart(accumulatedData);
        
        // Actualizar métricas de acumulado
        if (accumulatedData.length > 0) {
            const lastData = accumulatedData[accumulatedData.length - 1];
            
            document.getElementById('accumulated-sales-comparativo').textContent = formatCurrency(lastData.accumulatedSales);
            document.getElementById('accumulated-purchases-comparativo').textContent = formatCurrency(lastData.accumulatedPurchases);
            document.getElementById('accumulated-margin-comparativo').textContent = formatCurrency(lastData.accumulatedMargin);
            document.getElementById('accumulated-margin-percent-comparativo').textContent = `${lastData.accumulatedMarginPercent.toFixed(1)}%`;
            
            document.getElementById('accumulated-sales-period-comparativo').textContent = `Acumulado ${lastData.anio}`;
            document.getElementById('accumulated-purchases-period-comparativo').textContent = `Acumulado ${lastData.anio}`;
        }
        
        // Actualizar tabla de acumulado
        updateAccumulatedTable(accumulatedData);
    }

    // Actualizar gráfico de acumulado
    function updateAccumulatedChart(accumulatedData) {
        const canvas = document.getElementById('accumulated-chart-comparativo');
        const ctx = canvas.getContext('2d');
        
        if (accumulatedData.length === 0) {
            if (accumulatedChart) {
                accumulatedChart.destroy();
                accumulatedChart = null;
            }
            return;
        }
        
        // Nombres de meses en español
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        // Preparar datos para el gráfico
        const labels = accumulatedData.map(item => monthNames[item.mes - 1]);
        const salesData = accumulatedData.map(item => item.accumulatedSales);
        const purchasesData = accumulatedData.map(item => item.accumulatedPurchases);
        const marginData = accumulatedData.map(item => item.accumulatedMargin);
        
        // Configuración del gráfico
        const chartConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ventas Acumuladas',
                        data: salesData,
                        backgroundColor: 'rgba(76, 201, 240, 0.1)',
                        borderColor: 'rgb(76, 201, 240)',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(76, 201, 240)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Compras Acumuladas',
                        data: purchasesData,
                        backgroundColor: 'rgba(247, 37, 133, 0.1)',
                        borderColor: 'rgb(247, 37, 133)',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(247, 37, 133)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Margen Acumulado',
                        data: marginData,
                        backgroundColor: 'rgba(58, 12, 163, 0.1)',
                        borderColor: 'rgb(58, 12, 163)',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(58, 12, 163)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Evolución Acumulada ${accumulatedData[0].anio}`,
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return formatCurrencyCompact(value);
                            }
                        }
                    }
                }
            }
        };
        
        // Si ya existe un gráfico, destruirlo
        if (accumulatedChart) {
            accumulatedChart.destroy();
        }
        
        // Crear nuevo gráfico
        accumulatedChart = new Chart(ctx, chartConfig);
    }

    // Actualizar tabla de acumulado
    function updateAccumulatedTable(accumulatedData) {
        const tableBody = document.getElementById('accumulated-table-body-comparativo');
        tableBody.innerHTML = '';
        
        if (accumulatedData.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `
                <td colspan="5" style="text-align: center; padding: 30px;">
                    <div style="color: var(--gray); font-size: 16px;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>No hay datos disponibles para los filtros seleccionados.</p>
                    </div>
                </td>
            `;
            tableBody.appendChild(emptyRow);
            return;
        }
        
        // Nombres de meses en español
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        // Generar filas de la tabla
        accumulatedData.forEach(item => {
            const row = document.createElement('tr');
            
            // Determinar clase para el margen
            const marginClass = item.accumulatedMargin >= 0 ? 'value-positive' : 'value-negative';
            
            // Crear celdas
            row.innerHTML = `
                <td>${monthNames[item.mes - 1]} ${item.anio}</td>
                <td>${formatCurrency(item.accumulatedSales)}</td>
                <td>${formatCurrency(item.accumulatedPurchases)}</td>
                <td class="${marginClass}">${formatCurrency(item.accumulatedMargin)}</td>
                <td class="${marginClass}">${item.accumulatedMarginPercent.toFixed(1)}%</td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Actualizar todos los componentes
    function updateAllComponents() {
        updateSummaryCards();
        updateMainChart();
        updateMarginAnalysis();
        updateDataTable();
        updateAccumulatedData();
    }

    // Cargar datos automáticamente al inicializar
    fetchData();
}
</script>