<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Facturas y Notas de Crédito</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
        h1 { color: #333; text-align: center; }
        button { display: block; margin: 0 auto 20px auto; padding: 10px 15px; font-size: 16px; cursor: pointer; background-color: #0078d4; color: white; border: none; border-radius: 3px;}
        button:disabled { background-color: #ccc; }
        #error-message { color: #a00; font-weight: bold; margin-top: 10px; text-align: center;}
        #loading-message { margin-top: 10px; font-style: italic; color: #555; text-align: center;}
        #chart-container { width: 80%; max-width: 800px; margin: 20px auto; background-color: white; padding: 15px; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);}
        #data-container { display: flex; flex-wrap: wrap; gap: 15px; list-style: none; padding: 0; margin-top: 30px; justify-content: center;}
        .factura-card { 
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            width: calc(33% - 30px); 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            box-sizing: border-box;
            min-width: 250px;
        }
        .factura-card h3 { margin-top: 0; font-size: 1.1em; color: #005a9e; }
        .factura-card p { margin: 5px 0; font-size: 0.95em; }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .login-error {
            color: red;
            margin-top: 10px;
            font-size: 14px;
        }
        .hidden {
            display: none;
        }
        .summary-box {
            background-color: #e8f2fc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #0078d4;
            margin: 10px 0;
        }
        .summary-label {
            font-size: 14px;
            color: #666;
        }
        .summary-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px auto;
            max-width: 800px;
        }
        .summary-item {
            flex: 1;
            min-width: 200px;
            margin: 10px;
        }
        @media (max-width: 768px) { .factura-card { width: calc(50% - 20px); } }
        @media (max-width: 480px) { .factura-card { width: 100%; } }
    </style>
</head>
<body>
    <!-- Formulario de login -->
    <div id="login-section">
        <div class="login-container">
            <h2 style="text-align: center;">Acceso al Sistema</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Ingresar</button>
                <div id="login-error" class="login-error"></div>
            </form>
        </div>
    </div>

    <!-- Contenido principal (oculto inicialmente) -->
    <div id="main-content" class="hidden">
        <h1>Análisis de Facturas y Notas de Crédito</h1>

        <button id="load-button">Cargar Datos y Generar Estadísticas</button>

        <div id="loading-message" class="hidden">Cargando...</div>
        <div id="error-message"></div>

        <!-- Resumen de estadísticas -->
        <div id="summary-container" class="summary-container hidden">
            <div class="summary-item">
                <div class="summary-box">
                    <div class="summary-label">Total Facturado</div>
                    <div id="total-facturado" class="summary-value">$0</div>
                </div>
            </div>
            <div class="summary-item">
                <div class="summary-box">
                    <div class="summary-label">Total Notas de Crédito</div>
                    <div id="total-nc" class="summary-value">$0</div>
                </div>
            </div>
            <div class="summary-item">
                <div class="summary-box">
                    <div class="summary-label">Neto Real</div>
                    <div id="total-neto" class="summary-value">$0</div>
                </div>
            </div>
        </div>

        <div id="chart-container" class="hidden">
             <h2>Montos por Mes</h2>
             <canvas id="invoiceChart"></canvas>
        </div>

        <hr style="margin: 30px 0;">
        
        <h2 style="text-align: center;">Últimas Facturas</h2>
        <div id="data-container">
        </div>
    </div>

    <script>
        // Variables globales
        const loginSection = document.getElementById('login-section');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loadButton = document.getElementById('load-button');
        const dataContainer = document.getElementById('data-container');
        const chartContainer = document.getElementById('chart-container');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const summaryContainer = document.getElementById('summary-container');
        let myInvoiceChart = null;

        // URL del flujo (mantener la misma)
        const flowUrl = 'https://prod-77.westus.logic.azure.com:443/workflows/1ba29feb037d422bb281c8c8eacc4a04/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9gjMKfE5XIxBTi-KNXDcatl3NXchpZN6eGq8xDgrM5g'; 

        // Manejo de login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'prueba' && password === '123#') {
                // Login exitoso
                loginSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
            } else {
                // Error de login
                loginError.textContent = 'Usuario o contraseña incorrectos';
            }
        });

        // Formateo de moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CL', { 
                style: 'currency', 
                currency: 'CLP',
                maximumFractionDigits: 0
            }).format(value);
        }

        // Función para cargar los datos
        async function fetchData() {
            // Limpiar contenidos previos
            dataContainer.innerHTML = '';
            chartContainer.classList.add('hidden');
            summaryContainer.classList.add('hidden');
            
            if (myInvoiceChart) {
                myInvoiceChart.destroy();
            }
            
            errorMessage.innerHTML = '';
            loadingMessage.classList.remove('hidden');
            loadButton.disabled = true;

            if (!flowUrl || flowUrl.trim() === '') {
                errorMessage.textContent = 'Error: URL del flujo no configurada.';
                loadingMessage.classList.add('hidden');
                loadButton.disabled = false;
                return;
            }

            try {
                const response = await fetch(flowUrl);

                if (!response.ok) {
                    let errorText = response.statusText;
                    try {
                        const errorBody = await response.text();
                        if (errorBody) { errorText += `: ${errorBody}`; }
                    } catch(e) { /* Ignorar */ }
                    throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    console.error('Respuesta recibida (no es array):', data);
                    throw new Error('La respuesta recibida no es un array.');
                }

                if (data.length === 0) {
                    dataContainer.innerHTML = '<p style="text-align: center; margin-top: 20px;">No se encontraron facturas.</p>';
                } else {
                    // Preparar datos para el gráfico
                    const monthlyData = {};
                    let totalFacturas = 0;
                    let totalNC = 0;
                    let totalNeto = 0;

                    data.forEach(item => {
                        // Procesar la fecha
                        let fechaDoctoStr = item['Fecha_x0020_Docto'] || '';
                        let fechaObj = new Date(fechaDoctoStr);
                        let anio = fechaObj.getUTCFullYear();
                        let mes = String(fechaObj.getUTCMonth() + 1).padStart(2, '0');
                        let yearMonth = `${anio}-${mes}`;
                        
                        // Montos
                        const montoFactura = parseFloat(item.MontoFacturaOriginal) || 0;
                        const montoNC = parseFloat(item.MontoNotasCredito) || 0;
                        const montoNeto = parseFloat(item.MontoNetoReal) || 0;
                        
                        // Actualizar totales
                        totalFacturas += montoFactura;
                        totalNC += montoNC;
                        totalNeto += montoNeto;
                        
                        // Agregar al acumulado mensual
                        if (!monthlyData[yearMonth]) {
                            monthlyData[yearMonth] = {
                                facturas: 0,
                                notasCredito: 0,
                                neto: 0
                            };
                        }
                        
                        monthlyData[yearMonth].facturas += montoFactura;
                        monthlyData[yearMonth].notasCredito += montoNC;
                        monthlyData[yearMonth].neto += montoNeto;
                        
                        // Crear tarjeta para la factura
                        const card = document.createElement('div');
                        card.className = 'factura-card';
                        
                        // Formatear la fecha
                        let fechaFormateada = 'N/A';
                        if (!isNaN(fechaObj)) {
                            const dia = String(fechaObj.getUTCDate()).padStart(2, '0');
                            fechaFormateada = `${dia}/${mes}/${anio}`;
                        }
                        
                        const razonSocial = item['Razon_x0020_Social'] || 'N/A';
                        const folio = item.Folio || 'N/A';
                        
                        card.innerHTML = `
                            <h3>${razonSocial}</h3>
                            <p><strong>Folio:</strong> ${folio}</p>
                            <p><strong>Fecha:</strong> ${fechaFormateada}</p>
                            <p><strong>Monto Original:</strong> ${formatCurrency(montoFactura)}</p>
                            <p><strong>Notas de Crédito:</strong> ${formatCurrency(montoNC)}</p>
                            <p><strong>Monto Neto:</strong> ${formatCurrency(montoNeto)}</p>
                        `;
                        
                        dataContainer.appendChild(card);
                    });
                    
                    // Actualizar resumen estadístico
                    document.getElementById('total-facturado').textContent = formatCurrency(totalFacturas);
                    document.getElementById('total-nc').textContent = formatCurrency(totalNC);
                    document.getElementById('total-neto').textContent = formatCurrency(totalNeto);
                    summaryContainer.classList.remove('hidden');
                    
                    // Crear el gráfico
                    const sortedMonths = Object.keys(monthlyData).sort();
                    
                    if (sortedMonths.length > 0) {
                        chartContainer.classList.remove('hidden');
                        const ctx = document.getElementById('invoiceChart').getContext('2d');
                        
                        myInvoiceChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: sortedMonths,
                                datasets: [
                                    {
                                        label: 'Monto Facturas',
                                        data: sortedMonths.map(month => monthlyData[month].facturas),
                                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Notas de Crédito',
                                        data: sortedMonths.map(month => monthlyData[month].notasCredito),
                                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Monto Neto',
                                        data: sortedMonths.map(month => monthlyData[month].neto),
                                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                },
                                responsive: true,
                                maintainAspectRatio: true
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error detallado al cargar datos:', error);
                errorMessage.textContent = `Error al cargar datos: ${error.message}`;
            } finally {
                loadingMessage.classList.add('hidden');
                loadButton.disabled = false;
            }
        }

        loadButton.addEventListener('click', fetchData);
    </script>
</body>
</html>
