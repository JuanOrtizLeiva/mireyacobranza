<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico - Leer Datos Flujo</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #data-container li { 
            margin-bottom: 15px; 
            border-bottom: 1px solid #ccc; 
            padding-bottom: 10px; 
            font-size: 0.9em; /* Letra un poco más pequeña */
            word-wrap: break-word; /* Para que textos largos no rompan el diseño */
        }
        #error-message { color: red; margin-top: 15px; font-weight: bold;}
        #loading-message { margin-top: 15px; font-style: italic; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; margin-bottom: 20px; }
        pre { /* Estilo para el JSON crudo */
            background-color: #f4f4f4;
            padding: 5px;
            border: 1px solid #ddd;
            white-space: pre-wrap; /* Mantiene saltos de línea y espacios */
            word-wrap: break-word;
            margin-top: 5px;
            font-family: monospace; /* Fuente monoespaciada para JSON */
        }
    </style>
</head>
<body>

    <h1>Diagnóstico - Leer Datos desde Flujo Power Automate</h1>

    <button id="load-button">Cargar Datos del Flujo</button>

    <div id="loading-message" style="display: none;">Cargando...</div>
    <div id="error-message"></div>
    <ul id="data-container">
        </ul>

    <script>
        const loadButton = document.getElementById('load-button');
        const dataContainer = document.getElementById('data-container');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');

        // --- ¡¡ASEGÚRATE DE PONER LA URL DEL FLUJO CORRECTO AQUÍ!! ---
        //     (El flujo que lee del Lakehouse y usa el trigger HTTP nuevo o modificado)
        const flowUrl = 'https://prod-77.westus.logic.azure.com:443/workflows/1ba29feb037d422bb281c8c8eacc4a04/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9gjMKfE5XIxBTi-KNXDcatl3NXchpZN6eGq8xDgrM5g'; 
        // -------------------------------------------------------------

        async function fetchData() {
            dataContainer.innerHTML = '';
            errorMessage.innerHTML = '';
            loadingMessage.style.display = 'block';
            loadButton.disabled = true; 

             if (flowUrl === 'PegaAquíLaURLDelFlujoQueLeeElLakehouse' || !flowUrl || flowUrl.trim() === '') {
                errorMessage.textContent = 'Error: Configuración incompleta. Debes pegar la URL correcta de tu flujo de Power Automate en la variable "flowUrl".';
                loadingMessage.style.display = 'none';
                loadButton.disabled = false; 
                return; 
            }

            try {
                const response = await fetch(flowUrl); // Asume método GET

                if (!response.ok) {
                    let errorText = response.statusText;
                    try {
                       const errorBody = await response.text();
                       if(errorBody) { errorText += `: ${errorBody}`; }
                    } catch(e) { /* Ignorar */ }
                    throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
                }

                const data = await response.json(); // Intenta parsear como JSON

                if (!Array.isArray(data)) {
                     console.error('Respuesta recibida (no es array):', data); 
                     throw new Error('La respuesta recibida del flujo no es un array (lista de elementos) como se esperaba.');
                }

                if (data.length === 0) {
                    dataContainer.innerHTML = '<li>El flujo devolvió una lista vacía. Verifica si el Dataflow cargó datos al Lakehouse.</li>';
                } else {
                    data.forEach((item, index) => {
                        const listItem = document.createElement('li');
                        
                        // Intenta mostrar algunas columnas comunes (¡AJUSTA ESTOS NOMBRES SI LOS SABES!)
                        let commonData = `Fila ${index + 1}: `;
                        commonData += `Nro: ${item.Nro || 'N/A'}, `; // Ejemplo
                        commonData += `Rut: ${item['Rut cliente'] || 'N/A'}, `; // Ejemplo con espacio
                        commonData += `Razon: ${item['Razon Social'] || 'N/A'}`; // Ejemplo con espacio
                        
                        // Muestra los datos crudos (raw) del item en formato JSON
                        let rawData = '';
                        try {
                            rawData = JSON.stringify(item, null, 2); // null, 2 para indentación bonita
                        } catch (e) {
                            rawData = "Error al convertir el item a JSON";
                        }

                        // Combina todo en el elemento de lista
                        listItem.innerHTML = `${commonData}<br><strong>Datos Crudos (JSON):</strong><pre>${rawData}</pre>`;
                        
                        dataContainer.appendChild(listItem);
                    });
                }

            } catch (error) {
                console.error('Error detallado al cargar datos:', error);
                errorMessage.textContent = `Error al cargar datos: ${error.message}`;
            } finally {
                loadingMessage.style.display = 'none';
                loadButton.disabled = false;
            }
        }

        loadButton.addEventListener('click', fetchData);
    </script>

</body>
</html>
