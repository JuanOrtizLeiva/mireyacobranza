<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Leer Lista MS</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #data-container li { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #error-message { color: red; margin-top: 15px; font-weight: bold;}
        #loading-message { margin-top: 15px; font-style: italic; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; margin-bottom: 20px; }
    </style>
</head>
<body>

    <h1>Leer Datos de Microsoft List desde GitHub Pages</h1>

    <button id="load-button">Cargar Datos de la Lista</button>

    <div id="loading-message" style="display: none;">Cargando...</div>
    <div id="error-message"></div>
    <ul id="data-container">
        </ul>

    <script>
        const loadButton = document.getElementById('load-button');
        const dataContainer = document.getElementById('data-container');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');

        // --- PEGA AQUÍ LA URL DE TU FLUJO DE POWER AUTOMATE ---
        // Asegúrate de que la URL que pegues esté entre las comillas simples ' '
        const flowUrl = 'https://prod-77.westus.logic.azure.com:443/workflows/1ba29feb037d422bb281c8c8eacc4a04/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=9gjMKfE5XIxBTi-KNXDcatl3NXchpZN6eGq8xDgrM5g';
        // -------------------------------------------------------

        // Función asíncrona para obtener y mostrar los datos
        async function fetchData() {
            // Limpiar resultados anteriores y mostrar mensaje de carga
            dataContainer.innerHTML = '';
            errorMessage.innerHTML = '';
            loadingMessage.style.display = 'block';
            loadButton.disabled = true; // Deshabilitar botón mientras carga

            // Validar que la URL no sea la de ejemplo o esté vacía
             if (flowUrl === 'URL_DE_TU_FLUJO_HTTP_POST' || !flowUrl || flowUrl.trim() === '') {
                errorMessage.textContent = 'Error: Configuración incompleta. Debes pegar la URL de tu flujo de Power Automate en la variable "flowUrl" dentro del archivo index.html.';
                loadingMessage.style.display = 'none';
                loadButton.disabled = false; // Habilitar botón
                return; // Detener ejecución
            }

            try {
                // Hacer la llamada (fetch) al flujo usando el método GET (es el default de fetch)
                const response = await fetch(flowUrl);

                // Verificar si la respuesta de la red fue exitosa (status code 200-299)
                if (!response.ok) {
                    // Si hay un error HTTP, intentar leer el texto del error si existe
                    let errorText = response.statusText;
                    try {
                       const errorBody = await response.text();
                       if(errorBody) { errorText += `: ${errorBody}`; }
                    } catch(e) { /* Ignorar si no se puede leer el cuerpo del error */ }
                    throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
                }

                // Convertir la respuesta a formato JSON
                const data = await response.json();

                // Verificar si lo recibido es realmente un array
                if (!Array.isArray(data)) {
                     console.error('Respuesta recibida:', data); // Muestra en consola qué se recibió
                     throw new Error('La respuesta recibida del flujo no es un array (lista de elementos) como se esperaba.');
                }

                // Mostrar los datos en la página web
                if (data.length === 0) {
                    dataContainer.innerHTML = '<li>La lista está vacía o no se encontraron elementos.</li>';
                } else {
                    // Crear un elemento <li> por cada ítem recibido
                    data.forEach(item => {
                        const listItem = document.createElement('li');
                        // Accede a las columnas por su nombre interno (Title, Color, Cantidad)
                        // Asegúrate de que los nombres coincidan exactamente con los de tu lista en SharePoint
                        // Se usan operadores '||' para mostrar 'N/A' si un campo está vacío o no existe
                        listItem.textContent = `Título: ${item.Title || 'N/A'}, Color: ${item.Color || 'N/A'}, Cantidad: ${item.Cantidad !== undefined && item.Cantidad !== null ? item.Cantidad : 'N/A'}`;
                        dataContainer.appendChild(listItem);
                    });
                }

            } catch (error) {
                // Mostrar errores de red o de procesamiento en la página y en la consola
                console.error('Error detallado al cargar datos:', error);
                errorMessage.textContent = `Error al cargar datos: ${error.message}`;
            } finally {
                // Ocultar mensaje de carga y volver a habilitar el botón, haya habido éxito o error
                loadingMessage.style.display = 'none';
                loadButton.disabled = false;
            }
        }

        // Añadir el "escuchador" de eventos al botón para que llame a fetchData cuando se haga clic
        loadButton.addEventListener('click', fetchData);
    </script>

</body>
</html>